<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <meta name="renderer" content="webkit">
  <meta http-equiv="X-UA-Compatible" content="IE=edge" >
  <link rel="dns-prefetch" href="http://lch277.github.io">
  <title>水西</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta property="og:type" content="website">
<meta property="og:title" content="水西">
<meta property="og:url" content="http://lch277.github.io/index.html">
<meta property="og:site_name" content="水西">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="水西">
  
    <link rel="alternative" href="/atom.xml" title="水西" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link rel="stylesheet" href="/main.css?v=4.0.0.css">
  

  

</head>

<body>
  <div id="container" q-class="show:isCtnShow">
    <canvas id="anm-canvas" class="anm-canvas"></canvas>
    <div class="left-col" q-class="show:isShow">
      <div class="overlay"></div>
<div class="intrude-less">
	<header id="header" class="inner">
		<a href="/" class="profilepic">
			<img src="/images/avatar.png" class="js-avatar">
		</a>

		<hgroup>
		  <h1 class="header-author"><a href="/">水西</a></h1>
		</hgroup>

		
		<p class="header-subtitle">青青子衿，悠悠我心</p>
		

		<nav class="header-menu">
			<ul>
			
				<li><a href="/">主页</a></li>
	        
				<li><a href="/tags/随笔/">随笔</a></li>
	        
			</ul>
		</nav>
		<nav class="header-smart-menu">
	        
    		
    			
    			<a data-idx="0" q-on="click: openSlider(e, 'innerArchive')" href="javascript:void(0)">所有文章</a>
    			
    			
            
    			
            
    			
    			<a data-idx="1" q-on="click: openSlider(e, 'aboutme')" href="javascript:void(0)">关于我</a>
    			
    			
            
		</nav>
		<nav class="header-nav">
			<div class="social">
				
					<a class="github" target="_blank" href="#" title="github"><i class="icon-github"></i></a>
		        
					<a class="weibo" target="_blank" href="#" title="weibo"><i class="icon-weibo"></i></a>
		        
					<a class="rss" target="_blank" href="#" title="rss"><i class="icon-rss"></i></a>
		        
					<a class="zhihu" target="_blank" href="#" title="zhihu"><i class="icon-zhihu"></i></a>
		        
			</div>
		</nav>
	</header>		
</div>

    </div>
    <div class="mid-col" q-class="show:isShow,hide:isShow|isFalse">
      <nav id="mobile-nav">
  	<div class="overlay">
  		<div class="slider-trigger"><i class="icon-sort"></i></div>
  		<h1 class="header-author js-mobile-header hide">水西</h1>
  	</div>
	<div class="intrude-less">
		<header id="header" class="inner">
			<div class="profilepic">
				<img src="/images/avatar.png" class="js-avatar">
			</div>
			<hgroup>
			  <h1 class="header-author">水西</h1>
			</hgroup>
			
			<p class="header-subtitle">青青子衿，悠悠我心</p>
			
			<nav class="header-menu">
				<ul>
				
					<li><a href="/">主页</a></li>
		        
					<li><a href="/tags/随笔/">随笔</a></li>
		        
		        
		        	<li><a href="/archives/">所有文章</a></li>
		        
				</ul>
			</nav>
			<nav class="header-nav">
				<div class="social">
					
						<a class="github" target="_blank" href="#" title="github"><i class="icon-github"></i></a>
			        
						<a class="weibo" target="_blank" href="#" title="weibo"><i class="icon-weibo"></i></a>
			        
						<a class="rss" target="_blank" href="#" title="rss"><i class="icon-rss"></i></a>
			        
						<a class="zhihu" target="_blank" href="#" title="zhihu"><i class="icon-zhihu"></i></a>
			        
				</div>
			</nav>
		</header>				
	</div>
</nav>

      <div id="wrapper" class="body-wrap">
        <div class="menu-l">
          <div class="canvas-wrap">
            <canvas data-colors="#eaeaea" data-sectionHeight="100" data-contentId="js-content" id="myCanvas1" class="anm-canvas"></canvas>
          </div>
          <div id="js-content" class="content-ll">
            
  
    <article id="post-自建mongodb集群增加用户鉴权" class="article article-type-post  article-index" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/02/21/自建mongodb集群增加用户鉴权/">自建mongodb集群增加用户鉴权</a>
    </h1>
  

        <a href="/2017/02/21/自建mongodb集群增加用户鉴权/" class="archive-article-date">
  	<time datetime="2017-02-21T03:21:13.000Z" itemprop="datePublished"><i class="icon-calendar icon"></i>2017-02-21</time>
</a>
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="副本集的鉴权"><a href="#副本集的鉴权" class="headerlink" title="副本集的鉴权"></a>副本集的鉴权</h1><ul>
<li>副本成员之间的内部鉴权internal authentication</li>
<li>副本集与客户端之间的基于角色的用户鉴权role-based user authentication</li>
</ul>
<h1 id="流程"><a href="#流程" class="headerlink" title="流程"></a>流程</h1><h3 id="创建一个keyfile"><a href="#创建一个keyfile" class="headerlink" title="创建一个keyfile"></a>创建一个keyfile</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">openssl rand -base64 756 &gt; &lt;path-to-keyfile&gt;</div><div class="line">chmod 400 &lt;path-to-keyfile&gt;</div></pre></td></tr></table></figure>
<blockquote>
<p>keyfile的文件权限需要严格遵守，400是必须的，所以最好<code>chown mongod:mongod &lt;path-to-keyfile&gt;</code></p>
</blockquote>
<h3 id="拷贝keyfile到各个副本集成员"><a href="#拷贝keyfile到各个副本集成员" class="headerlink" title="拷贝keyfile到各个副本集成员"></a>拷贝keyfile到各个副本集成员</h3><blockquote>
<p>同样注意权限问题</p>
</blockquote>
<h3 id="在各副本成员上启用访问控制"><a href="#在各副本成员上启用访问控制" class="headerlink" title="在各副本成员上启用访问控制"></a>在各副本成员上启用访问控制</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">security:</div><div class="line">  keyFile: &lt;path-to-keyfile&gt;</div><div class="line">replication:</div><div class="line">  replSetName: &lt;replicaSetName&gt;</div></pre></td></tr></table></figure>
<blockquote>
<p>注意，启用keyfile之后，security下的<code>authentication: enabled</code>可以去掉了<br>net下的<code>bindIp: localhost,&lt;lan-ip&gt;</code>确保绑定到内网IP，多个IP之间用英文逗号隔开且不要加额外的空格</p>
</blockquote>
<h3 id="使用localhost连接到副本集成员"><a href="#使用localhost连接到副本集成员" class="headerlink" title="使用localhost连接到副本集成员"></a>使用localhost连接到副本集成员</h3><p>因为副本集刚启动，还没有创建用户，此时只能通过localhost连接副本成员创建用户</p>
<h3 id="初始化副本集"><a href="#初始化副本集" class="headerlink" title="初始化副本集"></a>初始化副本集</h3><p>副本集名必须与config文件中保持一致，member的host必须为内网ip<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">rs.initiate(</div><div class="line">  &#123;</div><div class="line">    _id : &lt;replicaSetName&gt;,</div><div class="line">    members: [</div><div class="line">      &#123; _id : 0, host : &quot;mongo1.example.net:27017&quot; &#125;,</div><div class="line">      &#123; _id : 1, host : &quot;mongo2.example.net:27017&quot; &#125;,</div><div class="line">      &#123; _id : 2, host : &quot;mongo3.example.net:27017&quot; &#125;</div><div class="line">    ]</div><div class="line">  &#125;</div><div class="line">)</div></pre></td></tr></table></figure></p>
<h3 id="创建管理员用户"><a href="#创建管理员用户" class="headerlink" title="创建管理员用户"></a>创建管理员用户</h3><p>使用db.createUser()在admin数据库上创建一个权限至少为userAdminAnyDatabase的用户<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">admin = db.getSiblingDB(&quot;admin&quot;)</div><div class="line">admin.createUser(</div><div class="line">  &#123;</div><div class="line">    user: &quot;fred&quot;,</div><div class="line">    pwd: &quot;changeme1&quot;,</div><div class="line">    roles: [ &#123; role: &quot;userAdminAnyDatabase&quot;, db: &quot;admin&quot; &#125; ]</div><div class="line">  &#125;</div><div class="line">)</div></pre></td></tr></table></figure></p>
<h3 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h3><p>参考官方文档 <a href="https://docs.mongodb.com/manual/tutorial/deploy-replica-set-with-keyfile-access-control/" target="_blank" rel="external">deploy-replica-set-with-keyfile-access-control</a></p>

      

      
    </div>
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags"></i>
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/mongodb/">mongodb</a></li></ul>
	</div>

      

      
        <p class="article-more-link">
          <a class="article-more-a" href="/2017/02/21/自建mongodb集群增加用户鉴权/">展开全文 >></a>
        </p>
      

      
      <div class="clearfix"></div>
    </div>
  </div>
</article>








  
    <article id="post-sql和mongodb中drill的实现" class="article article-type-post  article-index" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/02/10/sql和mongodb中drill的实现/">sql和mongodb中drill的实现</a>
    </h1>
  

        <a href="/2017/02/10/sql和mongodb中drill的实现/" class="archive-article-date">
  	<time datetime="2017-02-10T08:45:10.000Z" itemprop="datePublished"><i class="icon-calendar icon"></i>2017-02-10</time>
</a>
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>drill是多维分析中一个很典型的操作</p>
<p>通常多维数据包含：</p>
<ul>
<li>用户表，包含id、name、性别、年龄、年级、位置以及各种偏好等多维度信息</li>
<li>事实表，包含用户行为的多维信息表</li>
</ul>
<p>drill操作通常包含：</p>
<ul>
<li>选定用户群体（按用户的维度信息筛选）</li>
<li>用户群体的特定行为（按行为的维度信息组合筛选）</li>
<li>对上述行为按维度分组（用户维度、行为维度、时间维度）</li>
<li>对分组的数据进行聚合计算（max、min、mean、count）</li>
</ul>
<p>mysql实现</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">select</span> * <span class="keyword">from</span> <span class="keyword">users</span> a <span class="keyword">join</span> <span class="keyword">events</span> b <span class="keyword">on</span> a.uid=b.uid <span class="keyword">where</span> a.xxxxx <span class="keyword">and</span> b.xxxx <span class="keyword">group</span> <span class="keyword">by</span> a.xxx, b.xxx <span class="keyword">order</span> <span class="keyword">by</span> a.xxx, b.xxx <span class="keyword">limit</span> <span class="number">10</span></div></pre></td></tr></table></figure>
<p>mongodb实现</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">db.users.aggregate([</div><div class="line">    &#123;<span class="attr">$match</span>: &#123;<span class="attr">reg_time</span>: &#123;<span class="attr">$gte</span>: ISODate(<span class="string">"2017-01-14T01:40:25.000Z"</span>)&#125;&#125;&#125;,</div><div class="line">    &#123;<span class="attr">$lookup</span>: &#123;<span class="attr">from</span>: <span class="string">'events'</span>, <span class="attr">localField</span>: <span class="string">'uid'</span>, <span class="attr">foreignField</span>: <span class="string">'uid'</span>, <span class="attr">as</span>: <span class="string">'events'</span>&#125;&#125;,</div><div class="line">  	&#123;...&#125;, <span class="comment">// 打散</span></div><div class="line">    &#123;...&#125;, <span class="comment">// 分组聚合</span></div><div class="line">])</div></pre></td></tr></table></figure>

      

      
    </div>
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags"></i>
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/drill/">drill</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/mongodb/">mongodb</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/sql/">sql</a></li></ul>
	</div>

      

      
        <p class="article-more-link">
          <a class="article-more-a" href="/2017/02/10/sql和mongodb中drill的实现/">展开全文 >></a>
        </p>
      

      
      <div class="clearfix"></div>
    </div>
  </div>
</article>








  
    <article id="post-Countly服务器端源码分析" class="article article-type-post  article-index" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/02/08/Countly服务器端源码分析/">Countly服务器端源码分析</a>
    </h1>
  

        <a href="/2017/02/08/Countly服务器端源码分析/" class="archive-article-date">
  	<time datetime="2017-02-08T02:27:03.000Z" itemprop="datePublished"><i class="icon-calendar icon"></i>2017-02-08</time>
</a>
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="整体结构"><a href="#整体结构" class="headerlink" title="整体结构"></a>整体结构</h1><p>最新16.12.2源代码结构，前后端分离架构，后端基于nodejs的http模块提供api服务，前端基于Express和Backbone实现SPA应用，前后端分开部署，nginx反向代理实现url分发</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">/countly-server</div><div class="line">├── api				// 后端数据接收、处理api</div><div class="line">├── bin				// 安装维护脚本</div><div class="line">├── extend			</div><div class="line">├── frontend		// 前端数据分析仪表盘，backbone框架</div><div class="line">├── log</div><div class="line">├── plugins			// 插件系统</div><div class="line">└── test</div></pre></td></tr></table></figure>
<h1 id="后端（api）"><a href="#后端（api）" class="headerlink" title="后端（api）"></a>后端（api）</h1><p>后端是一个纯Restful 接口服务，代码结构如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">/api</div><div class="line">├─jobs</div><div class="line">├─lib</div><div class="line">├─parts</div><div class="line">│  ├─data</div><div class="line">│  ├─jobs</div><div class="line">│  └─mgmt</div><div class="line">├─utils</div><div class="line">├─api.js</div><div class="line">└─config.js</div></pre></td></tr></table></figure>
<p>具体功能：</p>
<ul>
<li>数据流API</li>
<li>整合插件管理</li>
<li>API集群管理</li>
</ul>
<h1 id="前端（frontend）"><a href="#前端（frontend）" class="headerlink" title="前端（frontend）"></a>前端（frontend）</h1><p>前端是一个基于backbone的SPA应用，Express提供静态资源托管。前端通过请求后端的数据API提供数据分析仪表盘</p>
<h1 id="插件开发"><a href="#插件开发" class="headerlink" title="插件开发"></a>插件开发</h1><h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>自 15.03 版起，Countly 便可以使用插件进行扩展。本指南将描述如何创建您自有的插件以扩展 Countly 功能。</p>
<h3 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h3><p>要了解如何创建插件，需要完成五个步骤</p>
<ul>
<li><a href="http://resources.count.ly/v2.0/docs/plugin-structure" target="_blank" rel="external">熟悉插件结构，添加/移除插件</a></li>
<li><a href="http://resources.count.ly/v2.0/docs/plugin-api-side" target="_blank" rel="external">创建 API 部分以处理插件的 REST API 请求</a></li>
<li><a href="http://resources.count.ly/v2.0/docs/plugins-frontend-server" target="_blank" rel="external">创建前端服务器脚本以处理前端请求（如有需要）</a></li>
<li><a href="http://resources.count.ly/v2.0/docs/plugins-frontend-browser-files" target="_blank" rel="external">将前端客户端浏览器文件组织到正确的插件结构中</a></li>
<li><a href="http://resources.count.ly/v2.0/docs/plugins-frontend-client-side" target="_blank" rel="external">创建模型获取和管理您的数据和视图以在 Countly 控制面板中显示</a></li>
<li><a href="http://resources.count.ly/docs/extending-or-modifying-modules" target="_blank" rel="external">修改现有插件的功能</a></li>
<li><a href="http://resources.count.ly/docs/shared-configurations" target="_blank" rel="external">使用公共文档来存储配置</a></li>
<li><a href="http://resources.count.ly/docs/logging" target="_blank" rel="external">使用Countly的集中式日志系统来更好的调试和输出</a></li>
<li><a href="http://resources.count.ly/docs/document-splitting" target="_blank" rel="external">使用MongoDB的文档拆分功能来拆分大量数据</a>，集群分片功能？</li>
</ul>
<h3 id="插件管理"><a href="#插件管理" class="headerlink" title="插件管理"></a>插件管理</h3><p>plugins目录源码结构</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line">/plugins</div><div class="line">├── browser</div><div class="line">├── compare</div><div class="line">├── crashes</div><div class="line">├── dbviewer</div><div class="line">├── density</div><div class="line">├── desktop</div><div class="line">├── empty</div><div class="line">├── enterpriseinfo</div><div class="line">├── errorlogs</div><div class="line">├── idfa_fix</div><div class="line">├── locale</div><div class="line">├── logger</div><div class="line">├── mobile</div><div class="line">├── pluginManager.js</div><div class="line">├── plugins</div><div class="line">├── plugins.default.json</div><div class="line">├── plugins.json</div><div class="line">├── populator</div><div class="line">├── push</div><div class="line">├── README.md</div><div class="line">├── reports</div><div class="line">├── server-stats</div><div class="line">├── slipping-away-users</div><div class="line">├── sources</div><div class="line">├── star-rating</div><div class="line">├── systemlogs</div><div class="line">├── updates</div><div class="line">├── views</div><div class="line">└── web</div></pre></td></tr></table></figure>
<p>其中：</p>
<ul>
<li>pluginManager.js 启用/禁用插件并将其与Countly相连</li>
<li>plugins.json 包含当前已启用的插件名字的json数组</li>
</ul>
<p>例如，如果我们已经启用了屏幕密度和区域插件，则plugins.json的内容如下：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[<span class="string">"density"</span>, <span class="string">"locale"</span>]</div></pre></td></tr></table></figure>
<p>此外，此文件夹包含所有可用插件，所有新插件也将放在各自的文件夹中。</p>
<blockquote>
<h3 id="Important-notice"><a href="#Important-notice" class="headerlink" title="Important notice"></a>Important notice</h3><p>文件夹名称应该与插件名称相同。</p>
</blockquote>
<h3 id="开始插件开发"><a href="#开始插件开发" class="headerlink" title="开始插件开发"></a>开始插件开发</h3><p>以下是开始开发插件时的一些提示和前提条件。</p>
<ul>
<li><p>禁用生产模式</p>
<p>默认情况下Countly在生产模式下工作，大量的前端文件被压缩和拼接，以加快仪表盘加载。但是当你开发插件时，在某些情况下，你也想修改前端/浏览器端文件。要立即查看更改，必须禁用生产模式。</p>
</li>
</ul>
<ul>
<li><p>更新本地化文件</p>
<p>本地化文件被分别处理并合并到一个单独的文件，所以如果您在插件中修改本地化文件，您需要特别地cd到countly目录并运行<code>grunt locales</code>，然后这些更改将显示在仪表板中。</p>
</li>
<li><p>更新服务器端文件</p>
<p>由于nodejs进程运行的是预加载的文件，因此每次更新服务器端文件时，您都需要重新启动此进程以使更改生效，这样做只需在服务器上运行<code>countly restart</code></p>
</li>
<li><p>使用插件模版</p>
<p>plugins目录下有个名为empty的插件模版。</p>
<p>开发插件的最好方法是拷贝empty模版并重命名为自己的插件。</p>
<p>之后你可以更改插件的package.json中的元数据，添加依赖等等。</p>
<p>您可以删除<code>yourplugin/frontend/public/localization/empty.properties</code>文件，并使用您的插件名称作为文件名创建自己的本地化文件。</p>
<p>最后剩下的就是在api服务器，前端服务器和前端浏览器端添加内容提供的标准插件文件。</p>
</li>
</ul>
<h2 id="插件结构"><a href="#插件结构" class="headerlink" title="插件结构"></a>插件结构</h2><p>插件文件夹内部的结构与 Countly 非常相似，都含有 api 部分和前端部分的文件。</p>
<p>还有其他可用文件。</p>
<p>插件结构示例如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">/dbviewer</div><div class="line">├── api</div><div class="line">│   └── api.js</div><div class="line">├── frontend</div><div class="line">│   ├── app.js</div><div class="line">│   └── public</div><div class="line">│       ├── javascripts</div><div class="line">│       │   ├── countly.models.js</div><div class="line">│       │   ├── countly.views.js</div><div class="line">│       │   └── json.human.js</div><div class="line">│       ├── localization</div><div class="line">│       │   ├── dbviewer_de.properties</div><div class="line">│       │   ├── ...</div><div class="line">│       ├── stylesheets</div><div class="line">│       │   └── main.css</div><div class="line">│       └── templates</div><div class="line">│           └── dbviewer.html</div><div class="line">├── install.js</div><div class="line">├── node_modules</div><div class="line">├── package.json</div><div class="line">├── tests.js</div><div class="line">└── uninstall.js</div></pre></td></tr></table></figure>
<p>下图显示了Countly插件的高级架构。它清晰的显示了Countly SDK，Countly  Core和数据库如何相互连接以及不同组件如何做的。</p>
<p><img src="../images/countly_high_level_plugin_architecture.png" alt="Countly High Level Plugin Architecture"></p>
<h3 id="package-json"><a href="#package-json" class="headerlink" title="package.json"></a>package.json</h3><p>此文件是标准的 nodejs 软件包文件，包含了插件和安装在插件目录中的相关性的信息，以及启用/禁用插件时显示在 Countly 控制面板上的信息。</p>
<p>package.json 内容示例如下：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  <span class="attr">"name"</span>: <span class="string">"countly-empty"</span>,</div><div class="line">  <span class="attr">"title"</span>: <span class="string">"Plugin template"</span>,</div><div class="line">  <span class="attr">"version"</span>: <span class="string">"0.0.0"</span>,</div><div class="line">  <span class="attr">"description"</span>: <span class="string">"Empty plugin template for creating new plugins"</span>,</div><div class="line">  <span class="attr">"author"</span>: <span class="string">"Count.ly"</span>,</div><div class="line">  <span class="attr">"homepage"</span>: <span class="string">"https://count.ly/marketplace/"</span>,</div><div class="line">  <span class="attr">"repository"</span> :&#123; <span class="attr">"type"</span> : <span class="string">"git"</span>, <span class="attr">"url"</span> : <span class="string">"http://github.com/Countly/countly-server.git"</span>&#125;,</div><div class="line">  <span class="attr">"bugs"</span>:&#123; <span class="attr">"url"</span> : <span class="string">"http://github.com/Countly/countly-server/issues"</span>&#125;,</div><div class="line">  <span class="attr">"keywords"</span>: [</div><div class="line">    <span class="string">"countly"</span>,</div><div class="line">    <span class="string">"analytics"</span>,</div><div class="line">    <span class="string">"mobile"</span>,</div><div class="line">    <span class="string">"plugins"</span>,</div><div class="line">	<span class="string">"template"</span></div><div class="line">  ],</div><div class="line">  <span class="attr">"dependencies"</span>: &#123;</div><div class="line">  &#125;,</div><div class="line">  <span class="attr">"private"</span>: <span class="literal">true</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="install-js"><a href="#install-js" class="headerlink" title="install.js"></a>install.js</h3><p>启用插件时将执行此文件。编写 install.js 文件时需要考虑：</p>
<p>1) 多次启用或禁用插件时可以多次执行此文件</p>
<p>2) 还会使用此文件升级插件以应用对先前版本所做的更改</p>
<p>3) Countly 不可能在执行此文件时（如安装期间）运行，因此，您必须管理到数据库和其他资料的自有连接</p>
<p>4) 此文件将在单独的节点流程中执行，因此，还必须正确结束文件以结束节点流程。例如，不要忘记在完成修改之后关闭数据库连接</p>
<p>install.js 内容示例：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> mongo = <span class="built_in">require</span>(<span class="string">'../../frontend/express/node_modules/mongoskin'</span>),</div><div class="line">  <span class="keyword">async</span> = <span class="built_in">require</span>(<span class="string">'../../api/utils/async.min.js'</span>),</div><div class="line">  fs = <span class="built_in">require</span>(<span class="string">'fs'</span>),</div><div class="line">  path = <span class="built_in">require</span>(<span class="string">"path"</span>),</div><div class="line">  countlyConfig = <span class="built_in">require</span>(<span class="string">'../../frontend/express/config'</span>);</div><div class="line"></div><div class="line"><span class="built_in">console</span>.log(<span class="string">"Installing plugin"</span>);</div><div class="line"></div><div class="line"></div><div class="line"><span class="built_in">console</span>.log(<span class="string">"Creating needed directories"</span>);</div><div class="line"><span class="keyword">var</span> dir = path.resolve(__dirname, <span class="string">''</span>);</div><div class="line">fs.mkdir(dir + <span class="string">'/../../frontend/express/public/folder'</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123; &#125;);</div><div class="line"></div><div class="line"><span class="built_in">console</span>.log(<span class="string">"Modifying database"</span>);</div><div class="line"><span class="keyword">var</span> dbName;</div><div class="line"><span class="keyword">if</span> (<span class="keyword">typeof</span> countlyConfig.mongodb === <span class="string">"string"</span>) &#123;</div><div class="line">  dbName = countlyConfig.mongodb;</div><div class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">typeof</span> countlyConfig.mongodb.replSetServers === <span class="string">'object'</span>) &#123;</div><div class="line">  countlyConfig.mongodb.db = countlyConfig.mongodb.db || <span class="string">'countly'</span>;</div><div class="line">  <span class="comment">//mongodb://db1.example.net,db2.example.net:2500/?replicaSet=test</span></div><div class="line">  dbName = countlyConfig.mongodb.replSetServers.join(<span class="string">","</span>) + <span class="string">"/"</span> + countlyConfig.mongodb.db;</div><div class="line">&#125; <span class="keyword">else</span> &#123;</div><div class="line">  dbName = (countlyConfig.mongodb.host + <span class="string">':'</span> + countlyConfig.mongodb.port + <span class="string">'/'</span> + countlyConfig.mongodb.db);</div><div class="line">&#125;</div><div class="line"><span class="keyword">if</span> (dbName.indexOf(<span class="string">"mongodb://"</span>) !== <span class="number">0</span>) &#123;</div><div class="line">  dbName = <span class="string">"mongodb://"</span> + dbName;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">var</span> countlyDb = mongo.db(dbName);</div><div class="line"></div><div class="line">countlyDb.collection(<span class="string">'apps'</span>).find(&#123;&#125;).toArray(<span class="function"><span class="keyword">function</span> (<span class="params">err, apps</span>) </span>&#123;</div><div class="line"></div><div class="line">  <span class="keyword">if</span> (!apps || err) &#123;</div><div class="line">    <span class="built_in">console</span>.log(<span class="string">"No apps to upgrade"</span>);</div><div class="line">    countlyDb.close();</div><div class="line">    <span class="keyword">return</span>;</div><div class="line">  &#125;</div><div class="line">  <span class="function"><span class="keyword">function</span> <span class="title">upgrade</span>(<span class="params">app, done</span>) </span>&#123;</div><div class="line">    <span class="built_in">console</span>.log(<span class="string">"Adding indexes to "</span> + app.name);</div><div class="line">    countlyDb.collection(<span class="string">'app_users'</span> + app._id).ensureIndex(&#123; <span class="string">"name"</span>: <span class="number">1</span> &#125;, done);</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">async</span>.forEach(apps, upgrade, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</div><div class="line">    <span class="built_in">console</span>.log(<span class="string">"Plugin installation finished"</span>);</div><div class="line">    countlyDb.close();</div><div class="line">  &#125;);</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<h3 id="uninstall-js"><a href="#uninstall-js" class="headerlink" title="uninstall.js"></a>uninstall.js</h3><p>与 install.js 类似，禁用插件时只执行此文件。适用于 install.js 的规则也适用于 uninstall.js 文件</p>
<h3 id="使用-index-js-进行-tests-js-或文件夹测试"><a href="#使用-index-js-进行-tests-js-或文件夹测试" class="headerlink" title="使用 index.js 进行 tests.js 或文件夹测试"></a>使用 index.js 进行 tests.js 或文件夹测试</h3><p>使用 Gruntfile.js 中的 npm test 命令启动所有测试时将执行此文件。</p>
<p>测试执行期间，将使用 JSHint 对所有插件文件进行质量检查然后再执行测试。</p>
<p>测试时您将对创建的 APP_ID、APP_KEY 和 API_KEY 具有访问权限并且可以对前端或 api 执行任何相关测试。</p>
<p>执行测试之后，您必须将应用程序数据重置为待清理。</p>
<p>为了进行测试，您将 <a href="https://github.com/visionmedia/superagent" target="_blank" rel="external">superagent</a> 模块用于请求并将 <a href="https://github.com/shouldjs/should.js" target="_blank" rel="external">shouldjs</a> 模块用于断言。以及将 testUtils 模块用于设置、数据和有益的方法。</p>
<p>测试前端比 api 部分略微复杂，因为我们需要对用户进行身份验证，然后检索 csrf 以对服务器进行任何 post 请求。使用 testutils 方法使此流程变得更为简单。</p>
<p>检出覆盖不同测试基础的示例：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> request = <span class="built_in">require</span>(<span class="string">'supertest'</span>);</div><div class="line"><span class="keyword">var</span> should = <span class="built_in">require</span>(<span class="string">'should'</span>);</div><div class="line"><span class="keyword">var</span> testUtils = <span class="built_in">require</span>(<span class="string">"../../../test/testUtils"</span>);</div><div class="line"><span class="comment">//请求url</span></div><div class="line">request = request(testUtils.url);</div><div class="line"></div><div class="line"><span class="comment">//数据将用于测试</span></div><div class="line"><span class="keyword">var</span> APP_KEY = <span class="string">""</span>;</div><div class="line"><span class="keyword">var</span> API_KEY_ADMIN = <span class="string">""</span>;</div><div class="line"><span class="keyword">var</span> APP_ID = <span class="string">""</span>;</div><div class="line"><span class="keyword">var</span> DEVICE_ID = <span class="string">"1234567890"</span>;</div><div class="line"></div><div class="line">describe(<span class="string">'Testing plugin'</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</div><div class="line"></div><div class="line">  <span class="comment">//简单的api 测试</span></div><div class="line">  describe(<span class="string">'Empty plugin'</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</div><div class="line">    it(<span class="string">'should have no data'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">done</span>) </span>&#123;</div><div class="line"></div><div class="line">      <span class="comment">//首次测试时，我们可以检索设置</span></div><div class="line">      API_KEY_ADMIN = testUtils.get(<span class="string">"API_KEY_ADMIN"</span>);</div><div class="line">      APP_ID = testUtils.get(<span class="string">"APP_ID"</span>);</div><div class="line">      APP_KEY = testUtils.get(<span class="string">"APP_KEY"</span>);</div><div class="line"></div><div class="line">      <span class="comment">//并提出请求</span></div><div class="line">      request</div><div class="line">        .get(<span class="string">'/o?api_key='</span> + API_KEY_ADMIN + <span class="string">'&amp;app_id='</span> + APP_ID + <span class="string">'&amp;method=ourplugin'</span>)</div><div class="line">        .expect(<span class="number">200</span>)</div><div class="line">        .end(<span class="function"><span class="keyword">function</span> (<span class="params">err, res</span>) </span>&#123;</div><div class="line">          <span class="keyword">if</span> (err) <span class="keyword">return</span> done(err);</div><div class="line">          <span class="keyword">var</span> ob = <span class="built_in">JSON</span>.parse(res.text);</div><div class="line">          ob.should.be.empty;</div><div class="line">          done();</div><div class="line">        &#125;);</div><div class="line">    &#125;);</div><div class="line">  &#125;);</div><div class="line"></div><div class="line">  <span class="comment">//正在测试前端</span></div><div class="line">  describe(<span class="string">'Posting data to front end'</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</div><div class="line">    <span class="comment">//我们首先进行身份验证</span></div><div class="line">    before(<span class="function"><span class="keyword">function</span> (<span class="params">done</span>) </span>&#123;</div><div class="line">      testUtils.login(request);</div><div class="line">      testUtils.waitLogin(done);</div><div class="line">    &#125;);</div><div class="line">    it(<span class="string">'should have no live data'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">done</span>) </span>&#123;</div><div class="line">      request</div><div class="line">        .post(<span class="string">"/events/iap"</span>)</div><div class="line">        .send(&#123;</div><div class="line">          <span class="attr">app_id</span>: APP_ID,</div><div class="line">          <span class="attr">somedata</span>: <span class="string">"data"</span>,</div><div class="line">          <span class="comment">//正在获取csrf</span></div><div class="line">          _csrf: testUtils.getCSRF()</div><div class="line">        &#125;)</div><div class="line">        .expect(<span class="number">200</span>)</div><div class="line">        .end(<span class="function"><span class="keyword">function</span> (<span class="params">err, res</span>) </span>&#123;</div><div class="line">          <span class="keyword">if</span> (err) <span class="keyword">return</span> done(err);</div><div class="line">          done();</div><div class="line">        &#125;);</div><div class="line">    &#125;);</div><div class="line">  &#125;);</div><div class="line"></div><div class="line">  <span class="comment">//重置应用程序数据</span></div><div class="line">  describe(<span class="string">'reset app'</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</div><div class="line">    it(<span class="string">'should reset data'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">done</span>) </span>&#123;</div><div class="line">      <span class="keyword">var</span> params = &#123; <span class="attr">app_id</span>: APP_ID &#125;;</div><div class="line">      request</div><div class="line">        .get(<span class="string">'/i/apps/reset?api_key='</span> + API_KEY_ADMIN + <span class="string">"&amp;args="</span> + <span class="built_in">JSON</span>.stringify(params))</div><div class="line">        .expect(<span class="number">200</span>)</div><div class="line">        .end(<span class="function"><span class="keyword">function</span> (<span class="params">err, res</span>) </span>&#123;</div><div class="line">          <span class="keyword">if</span> (err) <span class="keyword">return</span> done(err);</div><div class="line">          <span class="keyword">var</span> ob = <span class="built_in">JSON</span>.parse(res.text);</div><div class="line">          ob.should.have.property(<span class="string">'result'</span>, <span class="string">'Success'</span>);</div><div class="line">          <span class="comment">//等待清除数据</span></div><div class="line">          setTimeout(done, <span class="number">5000</span>)</div><div class="line">        &#125;);</div><div class="line">    &#125;);</div><div class="line">  &#125;);</div><div class="line"></div><div class="line">  <span class="comment">//随后，我们还可以进行测试以验证数据是否已清除</span></div><div class="line">  describe(<span class="string">'Verify empty plugin'</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</div><div class="line">    it(<span class="string">'should have no data'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">done</span>) </span>&#123;</div><div class="line">      request</div><div class="line">        .get(<span class="string">'/o?api_key='</span> + API_KEY_ADMIN + <span class="string">'&amp;app_id='</span> + APP_ID + <span class="string">'&amp;method=ourplugin'</span>)</div><div class="line">        .expect(<span class="number">200</span>)</div><div class="line">        .end(<span class="function"><span class="keyword">function</span> (<span class="params">err, res</span>) </span>&#123;</div><div class="line">          <span class="keyword">if</span> (err) <span class="keyword">return</span> done(err);</div><div class="line">          <span class="keyword">var</span> ob = <span class="built_in">JSON</span>.parse(res.text);</div><div class="line">          ob.should.be.empty;</div><div class="line">          done();</div><div class="line">        &#125;);</div><div class="line">    &#125;);</div><div class="line">  &#125;);</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<h2 id="插件API端"><a href="#插件API端" class="headerlink" title="插件API端"></a>插件API端</h2><p>由于 Countly API 端主要是 REST API，而其附带插件机制的工作原理也与之相似，都是通过 api 路径传输事件。</p>
<p>应该将处理 api 请求的文件命名为 api.js，并放在插件目录下的 api 文件夹中，如<strong>{plugin}/api/api.js</strong></p>
<p>它至少需要通过插件管理器从 Countly api 挂钩到其事件和common.js 以连接到数据库并使用其他有用的方法。</p>
<p>然后，您需要开始注册到它们上面的特定事件和操作。每个事件还会提供其自有的对象以及一些变量，如请求参数等。</p>
<p>示例 api.js 文件如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> plugin = &#123;&#125;,</div><div class="line">  common = <span class="built_in">require</span>(<span class="string">'../../../api/utils/common.js'</span>),</div><div class="line">  plugins = <span class="built_in">require</span>(<span class="string">'../../pluginManager.js'</span>);</div><div class="line"></div><div class="line">(<span class="function"><span class="keyword">function</span> (<span class="params">plugin</span>) </span>&#123;</div><div class="line">  <span class="comment">//编写api调用</span></div><div class="line">  plugins.register(<span class="string">"/i"</span>, <span class="function"><span class="keyword">function</span> (<span class="params">ob</span>) </span>&#123;</div><div class="line">    <span class="comment">//获取请求参数</span></div><div class="line">    <span class="keyword">var</span> params = ob.params;</div><div class="line"></div><div class="line">    <span class="comment">//检查是否存在我们所需的数据</span></div><div class="line">    <span class="keyword">if</span> (params.qstring.user_details) &#123;</div><div class="line">      <span class="comment">//如果是字符串，但我们期望的是，则对其进行解析</span></div><div class="line">      <span class="keyword">if</span> (<span class="keyword">typeof</span> params.qstring.ourplugin == <span class="string">"string"</span>) &#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">          params.qstring.ourplugin = <span class="built_in">JSON</span>.parse(params.qstring.ourplugin);</div><div class="line">        &#125; <span class="keyword">catch</span> (<span class="built_in">SyntaxError</span>) &#123;</div><div class="line">          <span class="built_in">console</span>.log(<span class="string">'Parse JSON failed'</span>);</div><div class="line">          <span class="comment">//我们未处理请求</span></div><div class="line">          <span class="keyword">return</span> <span class="literal">false</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="comment">//开始处理请求</span></div><div class="line"></div><div class="line">        <span class="comment">//通过返回 true通知内核我们正在处理</span></div><div class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      <span class="comment">//我们没有感兴趣的数据</span></div><div class="line">      <span class="keyword">return</span> <span class="literal">false</span>;</div><div class="line">    &#125;</div><div class="line">  &#125;);</div><div class="line">&#125;(plugin));</div><div class="line"></div><div class="line"><span class="built_in">module</span>.exports = plugin;</div></pre></td></tr></table></figure>
<h3 id="可用事件路径和参数"><a href="#可用事件路径和参数" class="headerlink" title="可用事件路径和参数"></a>可用事件路径和参数</h3><p>目前受支持的事件名称或插件基本上可以监听的插件：</p>
<p><a href="http://resources.count.ly/v2.0/docs/plugin-api-side#section-可用事件路径和参数" target="_blank" rel="external">官方参考手册</a></p>
<p><img src="../images/resources.count.ly_v2.0_docs_events_params.png" alt="resources.count.ly_v2.0_docs_events_params.png"></p>
<h3 id="参数对象"><a href="#参数对象" class="headerlink" title="参数对象"></a>参数对象</h3><p>在api端有一个通过许多方法传递的通用对象，它通常存储在名为“params”的变量中。该对象的Contens可以取决于api请求的类型以及处理该请求的阶段</p>
<p><a href="http://resources.count.ly/v2.0/docs/plugin-api-side#section-params-object" target="_blank" rel="external">官方参考手册</a></p>
<p><img src="../images/resources.count.ly_v2.0_docs_params_object.png" alt="resources.count.ly_v2.0_docs_params_object.png"></p>
<h3 id="取消请求"><a href="#取消请求" class="headerlink" title="取消请求"></a>取消请求</h3><p>在两种情况下可以取消请求，因此请求不会通过内核进行任何进一步处理。</p>
<p>监听<strong>/</strong>设定路径（任何请求）时，以及监听<strong>/</strong>设定 <strong>sdk</strong> 路径（任何 SDK 请求）时。要取消此请求，所有插件必须将 <strong>params</strong> 对象的<strong>cancelRequest</strong> 设置为 true。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">plugins.register(<span class="string">"/"</span>, <span class="function"><span class="keyword">function</span>(<span class="params">ob</span>)</span>&#123;</div><div class="line">  ob.params.cancelRequest = <span class="literal">true</span>;</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>内核将忽略对请求进行进一步处理</p>
<h3 id="用户验证"><a href="#用户验证" class="headerlink" title="用户验证"></a>用户验证</h3><p>并非所有数据都应该公开可用于添加、编辑、删除，甚至查看任何人向 Countly API 提出的请求。因此，您需要验证用户提供的 API_KEY 是否有权查看修改的数据。</p>
<p>由于一些插件事件是系统直接设置的或是在传输到插件之前验证过的，因此不需要对其进行验证，在少数情况下，还需要验证用户请求。</p>
<p><strong>“/“</strong> - 处理数据之前提出的任何 http 请求</p>
<p><strong>“/o”</strong> - 读取基本指标时的路径</p>
<p><strong>{custom paths}</strong> - 为插件定义的路径</p>
<p>针对此路劲上的插件事件，Countly 提供了验证函数，您可以选择相应函数进行验证。</p>
<p><strong>ob.validateUserForDataReadAPI</strong> - 用于验证用户是否至少具有请求的应用程序的用户角色的功能</p>
<p><strong>ob.validateUserForDataWriteAPI</strong> - 用于验证用户是否将权限写入应用程序，将自己添加为管理员或全局权力元的功能</p>
<p><strong>ob.validateUserForGlobalAdmin</strong> - 用于验证用户是否为全局管理员，以及此处是否需要应用程序 id 的功能</p>
<p><strong>ob.validateAppForWriteAPI</strong> - 用于验证 APP_KEY 是否属于任何应用程序，且将附加参数添加到参数对象（其中每个 SDK /i 请求都有）的功能。如：</p>
<p>params.app_id - 应用程序 id</p>
<p>params.app_cc - 应用程序国家</p>
<p>params.app_name - 应用程序名称</p>
<p>params.appTimezone - 应用程序时区</p>
<p>params.time - 请求时间</p>
<p>验证示例：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> plugin = &#123;&#125;,</div><div class="line">  common = <span class="built_in">require</span>(<span class="string">'../../../api/utils/common.js'</span>),</div><div class="line">  plugins = <span class="built_in">require</span>(<span class="string">'../../pluginManager.js'</span>);</div><div class="line"></div><div class="line">(<span class="function"><span class="keyword">function</span> (<span class="params">plugin</span>) </span>&#123;</div><div class="line"></div><div class="line">  <span class="comment">//正在处理一些自定义路径</span></div><div class="line">  plugins.register(<span class="string">"/i/ourplugin"</span>, <span class="function"><span class="keyword">function</span> (<span class="params">ob</span>) </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">//获取参数</span></div><div class="line">    <span class="keyword">var</span> params = ob.params; <span class="comment">//请求参数</span></div><div class="line">    <span class="keyword">var</span> validate = ob.validateUserForDataWriteAPI; <span class="comment">//用户验证</span></div><div class="line"></div><div class="line">    validate(params, <span class="function"><span class="keyword">function</span> (<span class="params">params</span>) </span>&#123;</div><div class="line">      <span class="comment">//用户已经过验证 </span></div><div class="line">      <span class="comment">//您可以处理请求</span></div><div class="line">    &#125;);</div><div class="line"></div><div class="line">    <span class="comment">//需要返回true，以便内核不会对路径不存在做出响应</span></div><div class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</div><div class="line">  &#125;);</div><div class="line">&#125;(plugin));</div><div class="line"></div><div class="line"><span class="built_in">module</span>.exports = plugin;</div></pre></td></tr></table></figure>
<h3 id="处理自定义路径"><a href="#处理自定义路径" class="headerlink" title="处理自定义路径"></a>处理自定义路径</h3><p>此外，要预定义事件路径，未通过核心 api.js（基本上未列在参考 api 和上表中）处理的任何路径将通过插件传输。</p>
<p>例如，如果调用如 <a href="http://count.ly/o/foobar" target="_blank" rel="external">http://count.ly/o/foobar</a> 之类的路径，首先会将其分派到插件，如果没有插件使用此路径，将通过 api 返回错误消息，指出这是一个不正确的路径。</p>
<p>要向核心说明插件使用此路径或在事件中以异步方式执行某些操作，则必须从事件处理程序中简单地返回true。</p>
<p>此外，当您处理自由自定义路径时，<strong>您的插件负责将任何输出提供到客户端</strong>，否则，此类 HTTP 将会超时。</p>
<p>自定义<strong>/o 路径方式</strong></p>
<blockquote>
<h3 id="自定义-o-路径方式"><a href="#自定义-o-路径方式" class="headerlink" title="自定义 /o 路径方式"></a>自定义 /o 路径方式</h3><p>将内核未处理的方法自定义为 /o 路径，基本上可以将其视为自定义路径。因此，应将其当作一种路径处理，不管插件是否使用请求都会返回布尔值，如果针对插件提出请求，则输出信息</p>
</blockquote>
<p>还要注意，在事件中您只需要注册一个子路径，例如 /o/foo 以及所有到 /o/foo/bar1 和 /o/foo/bar2 的请求都会被导向 /o/foo 事件，在此事件中您可以得到路径数组并处理请求。</p>
<p>处理自定义路径的示例如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> plugin = &#123;&#125;,</div><div class="line">  common = <span class="built_in">require</span>(<span class="string">'../../../api/utils/common.js'</span>),</div><div class="line">  plugins = <span class="built_in">require</span>(<span class="string">'../../pluginManager.js'</span>);</div><div class="line"></div><div class="line">(<span class="function"><span class="keyword">function</span> (<span class="params">plugin</span>) </span>&#123;</div><div class="line">  <span class="comment">//正在处理自定义路径</span></div><div class="line">  plugins.register(<span class="string">"/i/ourplugin"</span>, <span class="function"><span class="keyword">function</span> (<span class="params">ob</span>) </span>&#123;</div><div class="line">    <span class="comment">//获取参数</span></div><div class="line">    <span class="keyword">var</span> params = ob.params; <span class="comment">//请求参数</span></div><div class="line">    <span class="keyword">var</span> validate = ob.validateUserForDataWriteAPI; <span class="comment">//客户验证</span></div><div class="line">    <span class="keyword">var</span> paths = ob.paths;</div><div class="line">    validate(params, <span class="function"><span class="keyword">function</span> (<span class="params">params</span>) </span>&#123;</div><div class="line">      <span class="comment">//用户已经过验证，处理请求</span></div><div class="line">      <span class="keyword">switch</span> (paths[<span class="number">3</span>]) &#123;</div><div class="line">        <span class="keyword">case</span> <span class="string">'create'</span>:</div><div class="line">          <span class="comment">//新建对象</span></div><div class="line">          <span class="keyword">var</span> data = params.qstring;</div><div class="line">          <span class="comment">//验证是否需要数据并将对象写入数据库</span></div><div class="line">          common.db.collection(<span class="string">'ourplugin'</span>).insert(data, <span class="function"><span class="keyword">function</span> (<span class="params">err, app</span>) </span>&#123;</div><div class="line">            <span class="keyword">if</span> (err)</div><div class="line">              common.returnMessage(params, <span class="number">200</span>, err);</div><div class="line">            <span class="keyword">else</span></div><div class="line">              common.returnMessage(params, <span class="number">200</span>, <span class="string">"Success"</span>);</div><div class="line">          &#125;);</div><div class="line">          <span class="keyword">break</span>;</div><div class="line">        <span class="keyword">case</span> <span class="string">'update'</span>:</div><div class="line">          <span class="comment">//更新现有对象</span></div><div class="line">          <span class="keyword">var</span> id = params.qstring.id;</div><div class="line">          <span class="keyword">var</span> data = params.qstring;</div><div class="line">          <span class="comment">//验证是否需要数据并将对象写入数据库</span></div><div class="line">          common.db.collection(<span class="string">'ourplugin'</span>).update(&#123; <span class="attr">_id</span>: id &#125;, data, <span class="function"><span class="keyword">function</span> (<span class="params">err, app</span>) </span>&#123;</div><div class="line">            <span class="keyword">if</span> (err)</div><div class="line">              common.returnMessage(params, <span class="number">200</span>, err);</div><div class="line">            <span class="keyword">else</span></div><div class="line">              common.returnMessage(params, <span class="number">200</span>, <span class="string">"Success"</span>);</div><div class="line">          &#125;);</div><div class="line">          <span class="keyword">break</span>;</div><div class="line">        <span class="keyword">case</span> <span class="string">'delete'</span>:</div><div class="line">          <span class="comment">//删除现有对象</span></div><div class="line">          <span class="keyword">var</span> id = params.qstring.id;</div><div class="line">          common.db.collection(<span class="string">'ourplugin'</span>).remove(&#123; <span class="attr">_id</span>: id &#125;, <span class="function"><span class="keyword">function</span> (<span class="params">err, app</span>) </span>&#123;</div><div class="line">            <span class="keyword">if</span> (err)</div><div class="line">              common.returnMessage(params, <span class="number">200</span>, err);</div><div class="line">            <span class="keyword">else</span></div><div class="line">              common.returnMessage(params, <span class="number">200</span>, <span class="string">"Success"</span>);</div><div class="line">          &#125;);</div><div class="line">          <span class="keyword">break</span>;</div><div class="line">        <span class="keyword">default</span>:</div><div class="line">          common.returnMessage(params, <span class="number">400</span>, <span class="string">'Invalid path, must be one of /create, /update or /delete'</span>);</div><div class="line">          <span class="keyword">break</span>;</div><div class="line">      &#125;</div><div class="line">    &#125;);</div><div class="line">    <span class="comment">//需要返回 true，以便内核不会对路径不存在做出响应</span></div><div class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</div><div class="line">  &#125;);</div><div class="line">&#125;(plugin));</div><div class="line"></div><div class="line"><span class="built_in">module</span>.exports = plugin;</div></pre></td></tr></table></figure>
<h3 id="处理指标"><a href="#处理指标" class="headerlink" title="处理指标"></a>处理指标</h3><p>Countly 中最常见插件的用途是添加新指标以跟踪数据并显示在控制面板中，如现有指标：分辨率、电信公司等。因此，我们尝试简化此流程以便实现此目标。</p>
<p>添加新指标时，在 API 端首先要做的是执行监听<code>/session/metrics</code>事件然后修改指标对象以便收集数据。随后，Countly 内核便可以自动处理指标数据并存储在数据库中。</p>
<p>当然，在某些时候，您需要监听以读取路径 <strong><code>/o?method=mymetric</code></strong> 并返回此请求的指标数据。</p>
<p>验证用户之后，通过请求 Countly <code>fetch</code>模块并使用其辅助方法<strong><code>fetch.fetchTimeObj</code></strong> 完成指标数据输出</p>
<p>还要考虑的事情是，您需要在应用程序重置或删除时删除指标数据。</p>
<p>在 API 端就是这样。以下是通过添加指标调用我的指标的示例：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> plugin = &#123;&#125;,</div><div class="line">  common = <span class="built_in">require</span>(<span class="string">'../../../api/utils/common.js'</span>),</div><div class="line">  plugins = <span class="built_in">require</span>(<span class="string">'../../pluginManager.js'</span>),</div><div class="line">  fetch = <span class="built_in">require</span>(<span class="string">'../../../api/parts/data/fetch.js'</span>);</div><div class="line"></div><div class="line">(<span class="function"><span class="keyword">function</span> (<span class="params">plugin</span>) </span>&#123;</div><div class="line"></div><div class="line">  <span class="comment">//等待接收指标</span></div><div class="line">  plugins.register(<span class="string">"/session/metrics"</span>, <span class="function"><span class="keyword">function</span> (<span class="params">ob</span>) </span>&#123;</div><div class="line">    <span class="keyword">var</span> predefinedMetrics = ob.predefinedMetrics; <span class="comment">// 指标对象集</span></div><div class="line"></div><div class="line">    <span class="comment">//通知countly处理我们的指标</span></div><div class="line">    predefinedMetrics.push(&#123;</div><div class="line">      <span class="attr">db</span>: <span class="string">"mymetric"</span>, <span class="comment">//集合名称</span></div><div class="line">      metrics: [</div><div class="line">        &#123;</div><div class="line">          <span class="attr">name</span>: <span class="string">"_mymetric"</span>, <span class="comment">//在查询字符串中等待什么</span></div><div class="line">          set: <span class="string">"mymetric"</span>, <span class="comment">// 指标mymetric</span></div><div class="line">          short_code: <span class="string">"mymetric"</span> <span class="comment">//还可以提供简短名称</span></div><div class="line">        &#125;</div><div class="line">      ]</div><div class="line">    &#125;);</div><div class="line">  &#125;);</div><div class="line"></div><div class="line">  <span class="comment">//等待读取请求</span></div><div class="line">  plugins.register(<span class="string">"/o"</span>, <span class="function"><span class="keyword">function</span> (<span class="params">ob</span>) </span>&#123;</div><div class="line">    <span class="keyword">var</span> params = ob.params;</div><div class="line">    <span class="keyword">var</span> validateUserForDataReadAPI = ob.validateUserForDataReadAPI;</div><div class="line"></div><div class="line">    <span class="comment">//如果用户请求读取我们的指标</span></div><div class="line">    <span class="keyword">if</span> (params.qstring.method == <span class="string">"mymetric"</span>) &#123;</div><div class="line"></div><div class="line">      <span class="comment">//对用户进行验证并使用fetchTimeObj方法输出数据</span></div><div class="line">      validateUserForDataReadAPI(params, fetch.fetchTimeObj, <span class="string">'mymetric'</span>);</div><div class="line"></div><div class="line">      <span class="comment">//返回true，以便我们对此请求进行响应</span></div><div class="line">      <span class="keyword">return</span> <span class="literal">true</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">//否则，我们不会对此请求感兴趣</span></div><div class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</div><div class="line">  &#125;);</div><div class="line"></div><div class="line">  <span class="comment">//等待应用程序删除事件</span></div><div class="line">  plugins.register(<span class="string">"/i/apps/delete"</span>, <span class="function"><span class="keyword">function</span> (<span class="params">ob</span>) </span>&#123;</div><div class="line">    <span class="keyword">var</span> appId = ob.appId;</div><div class="line"></div><div class="line">    <span class="comment">//删除指标集合中的所有应用程序数据</span></div><div class="line">    common.db.collection(<span class="string">'mymetric'</span>).remove(&#123; <span class="string">'_id'</span>: &#123; <span class="attr">$regex</span>: appId + <span class="string">".*"</span> &#125; &#125;, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123; &#125;);</div><div class="line">  &#125;);</div><div class="line"></div><div class="line">  <span class="comment">//等待应用程序重置事件</span></div><div class="line">  plugins.register(<span class="string">"/i/apps/reset"</span>, <span class="function"><span class="keyword">function</span> (<span class="params">ob</span>) </span>&#123;</div><div class="line">    <span class="keyword">var</span> appId = ob.appId;</div><div class="line"></div><div class="line">    <span class="comment">//删除指标集合中的所有应用程序数据</span></div><div class="line">    common.db.collection(<span class="string">'mymetric'</span>).remove(&#123; <span class="string">'_id'</span>: &#123; <span class="attr">$regex</span>: appId + <span class="string">".*"</span> &#125; &#125;, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123; &#125;);</div><div class="line"></div><div class="line">  &#125;);</div><div class="line">&#125;(plugin));</div><div class="line"></div><div class="line"><span class="built_in">module</span>.exports = plugin;</div></pre></td></tr></table></figure>
<p>就是这样。现在，您可以向 Countly 发送包含您的自有指标的 <a href="http://resources.count.ly/v2.0/docs/i#optional-parameters" target="_blank" rel="external">标准指标请求</a> ，自有指标将会和其他指标一样被跟踪。</p>
<p>示例如下：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">/i?</div><div class="line">begin_session=1</div><div class="line">&amp;app_key=YOUR-APP-KEY</div><div class="line">&amp;device_id=YOUR_DEVICE_ID</div><div class="line">&amp;metrics=&#123;</div><div class="line">      "_os": "Android",</div><div class="line">      "_os_version": "4.1",</div><div class="line">      "_device": "Samsung Galaxy",</div><div class="line">      "_resolution": "1200x800",</div><div class="line">      "_carrier": "Vodafone",</div><div class="line">      "_app_version": "1.2",</div><div class="line">      "_mymetric": "myvalue"</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<blockquote>
<h3 id="i-bulk-requests"><a href="#i-bulk-requests" class="headerlink" title="/i/bulk requests"></a>/i/bulk requests</h3><p>无需特别处理批量请求，Countly 内核会将批量请求拆分为您的插件通常处理的那种单个 /i 请求。</p>
</blockquote>
<h2 id="前端服务器端文件"><a href="#前端服务器端文件" class="headerlink" title="前端服务器端文件"></a>前端服务器端文件</h2><p>由于是在前端服务器端上，因此，Countly 使用Express.js 添加新功能是非常容易的。</p>
<p>通过 EJS 模板，可以轻松将数据传输到您的模板并显示。</p>
<p>应该将处理前端请求的文件命名为 app.js，并存放在插件目录下的 frontend 文件夹中，如<strong>{plugin}/frontend/app.js</strong></p>
<p>您的 app.js 需要使用单一公共方法 init 导出对象，Countly 会将数据库连接、express app 实例和 express 引用传递到该方法，以便您可以按需要添加任何请求处理或中间件。</p>
<blockquote>
<h3 id="Countly-路径前缀"><a href="#Countly-路径前缀" class="headerlink" title="Countly 路径前缀"></a>Countly 路径前缀</h3><p>Countly 可能安装在域中的子目录下，在这种情况下，countlyConfig 将具有已定义的路径属性。注册请求通过快速应用程序时需要考虑</p>
</blockquote>
<p>示例 app.js 文件如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> plugin = &#123;&#125;,</div><div class="line">  countlyConfig = <span class="built_in">require</span>(<span class="string">'../../../frontend/express/config'</span>);</div><div class="line"></div><div class="line">(<span class="function"><span class="keyword">function</span> (<span class="params">plugin</span>) </span>&#123;</div><div class="line">  plugin.init = <span class="function"><span class="keyword">function</span> (<span class="params">app, countlyDb, express</span>) </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">//在此添加您的中间件或处理请求</span></div><div class="line">    app.get(countlyConfig.path + <span class="string">'/ourplugin'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">req, res, next</span>) </span>&#123;</div><div class="line"></div><div class="line">      <span class="comment">//获取 url 参数</span></div><div class="line">      <span class="keyword">var</span> parts = req.url.split(<span class="string">"/"</span>);</div><div class="line">      <span class="keyword">var</span> id = parts[parts.length - <span class="number">1</span>];</div><div class="line"></div><div class="line">      <span class="comment">//使用 countlyDB 读取数据库中的数据</span></div><div class="line">      countlyDb.collection(<span class="string">'ourplugin'</span>).findOne(&#123; <span class="string">'_id'</span>: id &#125;, <span class="function"><span class="keyword">function</span> (<span class="params">err, plugindata</span>) </span>&#123;</div><div class="line"></div><div class="line">        <span class="comment">//数据是否不可用</span></div><div class="line">        <span class="keyword">if</span> (err || !att) res.send(<span class="string">'404: Page not Found'</span>, <span class="number">404</span>);</div><div class="line">        <span class="keyword">else</span> &#123;</div><div class="line"></div><div class="line">          <span class="comment">//显示模板数据	</span></div><div class="line">          res.render(<span class="string">'../../../plugins/ourplugin/frontend/public/templates/default'</span>, &#123;</div><div class="line">            <span class="attr">path</span>: countlyConfig.path || <span class="string">""</span>,</div><div class="line">            <span class="attr">cdn</span>: countlyConfig.cdn || <span class="string">""</span>,</div><div class="line">            <span class="attr">data</span>: plugindata</div><div class="line">          &#125;);</div><div class="line">        &#125;</div><div class="line">      &#125;);</div><div class="line">    &#125;);</div><div class="line">  &#125;;</div><div class="line">&#125;(plugin));</div><div class="line"></div><div class="line"><span class="built_in">module</span>.exports = plugin;</div></pre></td></tr></table></figure>
<p>此示例将展现位于<code>{countly}/plugins/ourplugin/frontend/public/templates/default.html</code> 下的模板，此模板应该是 EJS 模板，您可以在其中处理和显示预填充的插件数据。</p>
<h3 id="拦截请求"><a href="#拦截请求" class="headerlink" title="拦截请求"></a>拦截请求</h3><p>通过内核注册任何其他请求之前已将请求注册传输到插件，这意味着任何请求都将首先传输到插件以便您可以进行覆盖或修改。</p>
<p>而在某些情况下，您会想拦截内核注册的请求以基于请求数据执行一些其他任务或修改请求等等。为此，您可以使用快速应用程序注册请求，并使用下一个函数将请求处理传输到 Countly 内核。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//在此添加您的中间件或处理请求</span></div><div class="line">app.get(countlyConfig.path+<span class="string">'/login'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">req, res, next</span>) </span>&#123;</div><div class="line">      </div><div class="line">  <span class="comment">//处理请求数据</span></div><div class="line">      </div><div class="line">  <span class="comment">//通过 Countly 处理自然登录流</span></div><div class="line">  next();</div><div class="line">  </div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<h3 id="更改-Countly-配置"><a href="#更改-Countly-配置" class="headerlink" title="更改 Countly 配置"></a>更改 Countly 配置</h3><p>一些 Countly 配置用于前端，甚至已传输到浏览器端并用在模板中。</p>
<p>您可以在插件中对其进行更改。每个 <strong>req</strong> 请求对象还包含 <strong>config</strong> 属性以及 Countly 的前端/快速/ config.js 的内容，您可以对每个特定请求进行单独修改</p>
<h3 id="检查用户是否进行身份验证"><a href="#检查用户是否进行身份验证" class="headerlink" title="检查用户是否进行身份验证"></a>检查用户是否进行身份验证</h3><p>有些页只有通过身份验证的用户才能访问。要检查用户是否已进行身份验证，只需检查他/她是否具有任何已定义的 uid。</p>
<p>此外，您可能要通过查看会话 gadm 属性来查看用户是否为全局管理员</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">app.get(countlyConfig.path+<span class="string">'/mypage'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">req, res, next</span>) </span>&#123;</div><div class="line">  </div><div class="line">  <span class="comment">//检查用户是否已进行身份验证</span></div><div class="line">  <span class="keyword">if</span> (req.session.uid) &#123;</div><div class="line">    </div><div class="line">    <span class="keyword">if</span>(req.session.gadm)&#123;</div><div class="line">      <span class="comment">//用户是全局管理员</span></div><div class="line">    &#125;</div><div class="line">    <span class="keyword">else</span>&#123;</div><div class="line">      <span class="comment">//用户是简单的用户</span></div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">else</span></div><div class="line">    <span class="comment">//重定向到登录页面</span></div><div class="line">  	res.redirect(countlyConfig.path+<span class="string">'/login'</span>);</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<h3 id="处理-POST-请求"><a href="#处理-POST-请求" class="headerlink" title="处理 POST 请求"></a>处理 POST 请求</h3><p>Countly 默认使用body parser中间件，因此处理 POST 请求与获取请求一样简单</p>
<ul>
<li><a href="http://resources.count.ly/v2.0/docs/plugins-frontend-server" target="_blank" rel="external">JavaScript</a></li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">app.post(countlyConfig.path+<span class="string">'/mypage'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">req, res, next</span>) </span>&#123;</div><div class="line">  </div><div class="line">  <span class="comment">//通过 post 检索的数据</span></div><div class="line">  <span class="built_in">console</span>.log(req.body)</div><div class="line">  </div><div class="line">  <span class="comment">//在此显示或重定向用户</span></div><div class="line">  res.end();</div><div class="line">  <span class="keyword">return</span> <span class="literal">true</span>;</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>可以轻松处理文件上传</p>
<ul>
<li><a href="http://resources.count.ly/v2.0/docs/plugins-frontend-server" target="_blank" rel="external">JavaScript</a></li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line">app.post(countlyConfig.path+<span class="string">'/mypage'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">req, res</span>) </span>&#123;</div><div class="line">  </div><div class="line">  <span class="comment">//您的文件数据位于 req.files.fieldname 中</span></div><div class="line">  <span class="keyword">var</span> tmp_path = req.files.fieldname.path,</div><div class="line">      target_path = __dirname + <span class="string">"/public/images/image.png"</span>,</div><div class="line">      type = req.files.app_image.type;</div><div class="line"></div><div class="line">  <span class="comment">// 检查文件类型</span></div><div class="line">  <span class="keyword">if</span> (type != <span class="string">"image/png"</span> &amp;&amp; type != <span class="string">"image/gif"</span> &amp;&amp; type != <span class="string">"image/jpeg"</span>) &#123;</div><div class="line">    </div><div class="line">    <span class="comment">//没有我们所需的，删除文件</span></div><div class="line">    fs.unlink(tmp_path, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;&#125;);</div><div class="line">    res.send(<span class="literal">false</span>);</div><div class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="comment">//否则，我们会获取图像并复制</span></div><div class="line">  fs.rename(tmp_path, target_path, <span class="function"><span class="keyword">function</span> (<span class="params">err</span>) </span>&#123;</div><div class="line">    </div><div class="line">    <span class="comment">//移除已上传的文件</span></div><div class="line">  	fs.unlink(tmp_path, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;&#125;);</div><div class="line">		</div><div class="line">    <span class="comment">//我们完成的输出</span></div><div class="line">    res.send(<span class="string">"uploaded"</span>);</div><div class="line">  &#125;);</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<h3 id="静态路径"><a href="#静态路径" class="headerlink" title="静态路径"></a>静态路径</h3><p>在大多数情况下，当为你的插件创建UI时，你会有你的插件特定的CSS和javascript文件，以及模板，应该可以被前端客户端从Web访问。</p>
<p>Countly 内核会自动将您的插件公共目录添加到静态路径列表中，因此， <strong><code>{countly}/plugins/yourplugin/frontend/public</code></strong>目录下的所有内容都将会自动呈现给所有人。</p>
<p>这些公共资源可以在模板中访问，或者通过 javascript 使用插件名称作为子路径进行加载。</p>
<p>因此，如果您想访问位于 {countly}/plugins/yourplugin/frontend/public/stylesheets/main.css 下的 css 文件，您必需使用 url：<a href="http://yourdomain.com/yourplugin/stylesheets/main.css" target="_blank" rel="external">http://yourdomain.com/yourplugin/stylesheets/main.css</a></p>
<p>此外，如有需要，您可以在前端插件上使用 <code>staticPaths</code> 方法指定自有静态路径。</p>
<p>您可以使用相同的方法覆盖一些现有静态文件，如重定向主要 css 请求到一些其他的主题 css 文件。</p>
<p>请注意，您应该使用 staticPaths 方法中的 app.use，因为它是在路由器中间件之前调用的</p>
<ul>
<li><a href="http://resources.count.ly/v2.0/docs/plugins-frontend-server" target="_blank" rel="external">JavaScript</a></li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> plugin = &#123;&#125;,</div><div class="line">  countlyConfig = <span class="built_in">require</span>(<span class="string">'../../../frontend/express/config'</span>);</div><div class="line"></div><div class="line">(<span class="function"><span class="keyword">function</span> (<span class="params">plugin</span>) </span>&#123;</div><div class="line">  plugin.staticPaths = <span class="function"><span class="keyword">function</span> (<span class="params">app, countlyDb, express</span>) </span>&#123;</div><div class="line">    <span class="comment">//将静态文件路径重定向到其他位置</span></div><div class="line">    app.use(countlyConfig.path + <span class="string">'/stylesheets/main.css'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">req, res, next</span>) </span>&#123;</div><div class="line">      res.redirect(countlyConfig.path + <span class="string">'/ourplugin/stylesheets/main.css'</span>);</div><div class="line">    &#125;);</div><div class="line"></div><div class="line">    <span class="comment">//添加您自有的新静态路径</span></div><div class="line">    app.use(countlyConfig.path + <span class="string">"/myfolder"</span>, express.static(__dirname + <span class="string">"/myfolder"</span>));</div><div class="line">  &#125;;</div><div class="line">&#125;(plugin));</div><div class="line"></div><div class="line"><span class="built_in">module</span>.exports = plugin;</div></pre></td></tr></table></figure>
<h3 id="前端方法"><a href="#前端方法" class="headerlink" title="前端方法"></a>前端方法</h3><p>大多数情况下，通过 Express.js 的拦截请求方法进行处理，然后再通过 Countly 内核处理。但某些情况下，您可能希望获悉有关一些特定操作或在 Countly 流内进行更改。</p>
<p>例如，您不想监听所有<code>/login</code>调用，但您可能需要了解用户成功登录的时间。或者您可能要修改公开到控制面板或传输到 EJS 模板的 javascript 对象。您可能还要取消一些前端请求的 CSRF。</p>
<p>为了实现此目标，您可以为将在某些特定情况下调用的插件对象的前端部分定义方法。</p>
<p>每个方法都会获取以下对象：</p>
<ul>
<li>req - 请求对象</li>
<li>res - 响应对象</li>
<li>next - express js 下一级回调</li>
<li>data - 一些其他信息</li>
</ul>
<p><a href="http://resources.count.ly/v2.0/docs/plugins-frontend-server#section-前端方法" target="_blank" rel="external">官方参考手册</a></p>
<p><img src="../images/resources.count.ly_v2.0_docs_plugins_frontend_methods_objects.png" alt=""></p>
<p>使用前端方法的示例代码</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> plugin = &#123;&#125;,</div><div class="line">  countlyConfig = <span class="built_in">require</span>(<span class="string">'../../../frontend/express/config'</span>);</div><div class="line"></div><div class="line">(<span class="function"><span class="keyword">function</span> (<span class="params">plugin</span>) </span>&#123;</div><div class="line">  plugin.init = <span class="function"><span class="keyword">function</span> (<span class="params">app, countlyDb</span>) </span>&#123;</div><div class="line">    <span class="comment">//按预期在此添加新请求句柄</span></div><div class="line">    app.post(countlyConfig.path + <span class="string">'/nocsrf'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">req, res, next</span>) </span>&#123;</div><div class="line">      res.write(<span class="literal">true</span>);</div><div class="line">    &#125;)</div><div class="line">  &#125;;</div><div class="line"></div><div class="line">  plugin.staticPaths = <span class="function"><span class="keyword">function</span> (<span class="params">app, countlyDb, express</span>) </span>&#123;</div><div class="line">    <span class="comment">//将静态文件路径重定向到其他位置</span></div><div class="line">    app.use(countlyConfig.path + <span class="string">'/stylesheets/main.css'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">req, res, next</span>) </span>&#123;</div><div class="line">      res.redirect(countlyConfig.path + <span class="string">'/ourplugin/stylesheets/main.css'</span>);</div><div class="line">    &#125;);</div><div class="line"></div><div class="line">    <span class="comment">//添加您自有的新静态路径</span></div><div class="line">    app.use(countlyConfig.path + <span class="string">"/myfolder"</span>, express.static(__dirname + <span class="string">"/myfolder"</span>));</div><div class="line">  &#125;;</div><div class="line"></div><div class="line">  <span class="comment">//跳过 nocsrf 请求的 csrf</span></div><div class="line">  plugin.skipCSRF = <span class="function"><span class="keyword">function</span> (<span class="params">ob</span>) </span>&#123;</div><div class="line">    <span class="keyword">if</span> (ob.req.path == countlyConfig.path + <span class="string">"/nocsrf"</span>)</div><div class="line">      <span class="keyword">return</span> <span class="literal">true</span>;</div><div class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</div><div class="line">  &#125;;</div><div class="line"></div><div class="line">  <span class="comment">//添加其他对象以显示在控制面板上</span></div><div class="line">  plugin.renderDashboard = <span class="function"><span class="keyword">function</span> (<span class="params">ob</span>) </span>&#123;</div><div class="line">    <span class="comment">//通过浏览器端可以进行访问，如</span></div><div class="line">    <span class="comment">//countlyGlobal.myValue</span></div><div class="line">    ob.data.countlyGlobal.myValue = <span class="number">42</span>;</div><div class="line">  &#125;</div><div class="line">&#125;(plugin));</div><div class="line"></div><div class="line"><span class="built_in">module</span>.exports = plugin;</div></pre></td></tr></table></figure>
<h2 id="前端浏览器文件"><a href="#前端浏览器文件" class="headerlink" title="前端浏览器文件"></a>前端浏览器文件</h2><p>本页介绍了在 Countly 访客浏览器中执行的代码，这有助于您为 Countly 新建页面和视图。</p>
<p>在浏览器端，Countly 使用 Backbone.js 和 Handlebar 模板库渲染视图，使用模型加载和准备视图数据</p>
<blockquote>
<p> 相对路径</p>
<p> 开发客户端前端需要考虑的一件事就是可以将 Countly 安装在子目录下。因此，请尝试使用相对路径（如在 css 文件或 html 中）或使用 countly 配置路径的绝对路径。</p>
</blockquote>
<h3 id="所需文件"><a href="#所需文件" class="headerlink" title="所需文件"></a>所需文件</h3><p>默认情况下，Countly 期望您具有以下文件：</p>
<p>• 一个位于 stylesheets 文件夹中，名为 mains.css 的 css 文件<br>• 两个位于 javascripts 文件夹中，名为 countly.models.js 和 countly.views.js 的 js 文件<br>• 一个位于本地化文件夹中，您支持语言的对应语言文件</p>
<p>这些文件都是 Countly 在默认控制面板模板中自动加载以用于修改 Countly 用户界面的文件。</p>
<p>如果您需要加载其他的 CSS 或 Javascript 文件，您必须在 countly.views.js 文件中动态加载</p>
<p><strong>本地化</strong></p>
<p>您要支持的每种语言的本地化文件应该是 <a href="http://en.wikipedia.org/wiki/.properties" target="_blank" rel="external">.properties</a> 格式的，但至少要有一个默认的英文文件。</p>
<p>默认英文文件的命名约定是插件名加上属性扩展名，如 ourplugin.properties。</p>
<p>随后将任何其他语言添加到相同的路径下，但按照语言 ISO 标准，会将 Alpha 2 代码附加到默认文件名。</p>
<p>例如：</p>
<ul>
<li><a href="http://resources.count.ly/v2.0/docs/plugins-frontend-browser-files" target="_blank" rel="external">Text</a></li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">ourplugin_fr.properties</div><div class="line">ourplugin_lv.properties</div><div class="line">ourplugin_tr.properties</div></pre></td></tr></table></figure>
<p><strong>图像</strong></p>
<p>如果插件需要显示任何类型的图像，那么这些图像必须位于含有插件名称的文件夹下的图像文件夹中。</p>
<p><strong>其他文件</strong></p>
<p>您可以在任何结构中添加任何其他文件，如创建模板目录并添加文件以便稍后可以使用 ajax 请求获取、使用 Handlebar 处理并显示在主干视图中。</p>
<p><strong>示例</strong></p>
<p>假设插件名为 “ourplugin”，那么插件目录下的文件位置如下：</p>
<ul>
<li><a href="http://resources.count.ly/v2.0/docs/plugins-frontend-browser-files" target="_blank" rel="external">Text</a></li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">───frontend</div><div class="line">   │</div><div class="line">   └───public</div><div class="line">       ├───images</div><div class="line">       │   └───ourplugin</div><div class="line">       │           image1.png</div><div class="line">       │           image2.png</div><div class="line">       │</div><div class="line">       ├───javascripts</div><div class="line">       │       countly.models.js</div><div class="line">       │       countly.views.js</div><div class="line">       │</div><div class="line">       ├───localization</div><div class="line">       │       ourplugin.properties</div><div class="line">       │</div><div class="line">       ├───stylesheets</div><div class="line">       │       main.css</div><div class="line">       │</div><div class="line">       └───templates</div><div class="line">               tempalte2.html</div><div class="line">               template1.html</div></pre></td></tr></table></figure>
<h3 id="生产模式"><a href="#生产模式" class="headerlink" title="生产模式"></a>生产模式</h3><p>在开发模式下，插件的每个文件，如 main.css 或 countly.views.js 都会自动从其原始位置请求并按预期方式工作。</p>
<p>但是启用生产模式之后，Countly 会将相似的文件合并为一个文件，然后将其复制到内核。这样，服务器便会在单独请求每个文件时使用较少的 HTTP 请求进行处理。</p>
<p><strong>Javascript 文件</strong></p>
<p>每个插件中的两个 Javascript 文件（countly.models.js 和 countly.views.js）都是使用 <a href="https://github.com/mishoo/UglifyJS" target="_blank" rel="external">Uglify.js</a>预编译的。因此，您必须确保通过它可以处理您的 Javascript 文件，并且不会因为语法或脚本不正确导致出错。</p>
<p>每个插件的启用或禁用操作使用此编译器来处理所有已启用的插件视图和模型文件，并将它们组合在一起，并保存在<code>{countly} /frontend/express/public/javascripts/min/countly.plugins.js</code>文件中。</p>
<p><strong>CSS 文件</strong></p>
<p>所有 CSS 文件还会组合成一个单一的文件并存储在 <code>{countly}/frontend/express/public/stylesheets/main.min.css</code> 中</p>
<p>但是，由于推荐做法中CSS的所有路径应该使用相对路径（由于Countly可能安装为子目录），所有您对图像的引用在那一点被打破，这就是为什么我们来到我们的最后一点。</p>
<p><strong>图像</strong></p>
<p>保持图像结构类似于Countly原始结构的原因是因为在生产模式下复制CSS文件时，还会复制在插件图像目录中具有插件名称的文件夹，以保持与CSS文件的相对链接。</p>
<p>因此，如果您有位于<code>{countly}/plugins/ourplugin/frontend/public/images/ourplugin</code>文件夹的图像，那么在生产模式下，它们将被复制和引用<br><code>{countly}/frontend/express/public/images/ourplugin</code>文件夹保持与CSS文件相同的相对状态。</p>
<h3 id="外部依赖项"><a href="#外部依赖项" class="headerlink" title="外部依赖项"></a>外部依赖项</h3><p>如果有任何外部 js 或 css 依赖项，将它们分别放在与 countly.view.js 和 countly.model.js 相同的 javascript 文件夹中（或 stylesheets 文件夹对于 css 文件），随后这些依赖项会分别被压缩和合并到文件 countly.plugins.js 和 plugins.min.css 中。因此，在生产模式下，您不需要单独使用它们。</p>
<p>在开发模式下，您需要使用辅助功能加载它们。要区分生产模式和开发模式，请使用全局变量<code>production</code>。</p>
<ul>
<li><a href="http://resources.count.ly/v2.0/docs/plugins-frontend-browser-files" target="_blank" rel="external">JavaScript</a></li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span>(!production)&#123;</div><div class="line">  CountlyHelpers.loadJS(<span class="string">"ourplugin/javascripts/external.min.js"</span>);</div><div class="line">  CountlyHelpers.loadCSS(<span class="string">"ourplugin/stylesheets/external.min.css"</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="前端客户端文件"><a href="#前端客户端文件" class="headerlink" title="前端客户端文件"></a>前端客户端文件</h2><p>现在让我们讨论如何通过添加新的Countly视图到仪表板为你的插件构建一个UI。</p>
<p>我们知道<a href="http://resources.count.ly/v2.0/docs/plugins-frontend-browser-files" target="_blank" rel="external">某些文件会自动加载到Countly 控制面板</a>，现在使用这些文件（基本上是 countly.models.js 和 countly.views.js），我们可以从 API 获取数据并进行显示。</p>
<p>所以，我们需要实现的是：</p>
<ul>
<li>创建一个可以从API获取数据的模型</li>
<li>创建一个Backbone视图，它将从模型中获取数据并将其加载到模板中并附加到页面</li>
<li>将此视图添加到应用程序路由器</li>
<li>注入一些Javascript来修改页面，比如为我们的插件创建一个菜单项</li>
</ul>
<h3 id="countly-models-js"><a href="#countly-models-js" class="headerlink" title="countly.models.js"></a>countly.models.js</h3><p>现在，我们来定义一个简单的模型，以通过路径 /o?method=ourplugin 从 api 获取数据</p>
<ul>
<li><a href="http://resources.count.ly/v2.0/docs/plugins-frontend-client-side" target="_blank" rel="external">JavaScript</a></li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line">(<span class="function"><span class="keyword">function</span> (<span class="params">countlyOurplugin, $</span>) </span>&#123;</div><div class="line"></div><div class="line">  <span class="comment">//我们将在此存储数据</span></div><div class="line">  <span class="keyword">var</span> _data = &#123;&#125;;</div><div class="line"></div><div class="line">  <span class="comment">//正在初始化模块</span></div><div class="line">  countlyOurplugin.initialize = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">//正在返回承诺</span></div><div class="line">    <span class="keyword">return</span> $.ajax(&#123;</div><div class="line">      <span class="attr">type</span>: <span class="string">"GET"</span>,</div><div class="line">      <span class="attr">url</span>: <span class="string">"/o"</span>,</div><div class="line">      <span class="attr">data</span>: &#123;</div><div class="line">        <span class="comment">//正在提供当前用户的 api 键值</span></div><div class="line">        <span class="string">"api_key"</span>: countlyGlobal.member.api_key,</div><div class="line">        <span class="comment">//正在提供当前的 app id</span></div><div class="line">        <span class="string">"app_id"</span>: countlyCommon.ACTIVE_APP_ID,</div><div class="line">        <span class="comment">//正在指定方法参数</span></div><div class="line">        <span class="string">"method"</span>: <span class="string">"ourplugin"</span></div><div class="line">      &#125;,</div><div class="line">      <span class="attr">success</span>: <span class="function"><span class="keyword">function</span> (<span class="params">json</span>) </span>&#123;</div><div class="line">        <span class="comment">//获取数据并存储</span></div><div class="line">        _data = json;</div><div class="line">      &#125;</div><div class="line">    &#125;);</div><div class="line">  &#125;;</div><div class="line"></div><div class="line">  <span class="comment">//返回我们所拥有的数据</span></div><div class="line">  countlyOurplugin.getData = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</div><div class="line">    <span class="keyword">return</span> _data;</div><div class="line">  &#125;;</div><div class="line"></div><div class="line">&#125;(<span class="built_in">window</span>.countlyOurplugin = <span class="built_in">window</span>.countlyOurplugin || &#123;&#125;, jQuery));</div></pre></td></tr></table></figure>
<h3 id="本地化"><a href="#本地化" class="headerlink" title="本地化"></a>本地化</h3><p>有两种方法可以在 Countly 中提供本地化的字符串。</p>
<p>通过 javascript 使用全局 jQuery.i18n.map 对象从 localized .properties 文件预先获取值</p>
<ul>
<li><a href="http://resources.count.ly/v2.0/docs/plugins-frontend-client-side" target="_blank" rel="external">JavaScript</a></li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">alert(jQuery.i18n.map[<span class="string">"ourplugin.hello"</span>]);</div></pre></td></tr></table></figure>
<p>或者通过数据属性，呈现时元素会含有添加为元素内容的已经本地化的字符串</p>
<ul>
<li><a href="http://resources.count.ly/v2.0/docs/plugins-frontend-client-side" target="_blank" rel="external">HTML</a></li>
</ul>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment">&lt;!-- This will be changed  --&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">data-localize</span>=<span class="string">"ourplugin.title"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line"></div><div class="line"><span class="comment">&lt;!-- To this, automatically --&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">data-localize</span>=<span class="string">"ourplugin.title"</span>&gt;</span>Our Plugin<span class="tag">&lt;/<span class="name">div</span>&gt;</span></div></pre></td></tr></table></figure>
<h3 id="countly-views-js"><a href="#countly-views-js" class="headerlink" title="countly.views.js"></a>countly.views.js</h3><p>现在，我们创建一个基本 Countly 视图，以使用模型获取数据</p>
<ul>
<li><a href="http://resources.count.ly/v2.0/docs/plugins-frontend-client-side" target="_blank" rel="external">JavaScript</a></li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">window</span>.OurpluginView = countlyView.extend(&#123;</div><div class="line"></div><div class="line">  <span class="comment">//至少需要提供空的初始化函数</span></div><div class="line">  <span class="comment">//防止使用默认模板</span></div><div class="line">  initialize: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</div><div class="line">    <span class="comment">//我们可以在此进行初始化</span></div><div class="line">  &#125;,</div><div class="line"></div><div class="line">  <span class="attr">beforeRender</span>: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">//检查我们是否已拥有模板</span></div><div class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.template)</div><div class="line"></div><div class="line">      <span class="comment">//然后初始化我们的模式</span></div><div class="line">      <span class="keyword">return</span> $.when(countlyOurplugin.initialize()).then(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123; &#125;);</div><div class="line">    <span class="keyword">else</span> &#123;</div><div class="line"></div><div class="line">      <span class="comment">//否则获取模板且并行初始化我们的模式</span></div><div class="line">      <span class="keyword">var</span> self = <span class="keyword">this</span>;</div><div class="line">      <span class="keyword">return</span> $.when($.get(countlyGlobal[<span class="string">"path"</span>] + <span class="string">'/ourplugin/templates/default.html'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">src</span>) </span>&#123;</div><div class="line"></div><div class="line">        <span class="comment">//预编译我们的模板</span></div><div class="line">        self.template = Handlebars.compile(src);</div><div class="line">      &#125;), countlyOurplugin.initialize()).then(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123; &#125;);</div><div class="line">    &#125;</div><div class="line">  &#125;,</div><div class="line"></div><div class="line">  <span class="comment">//我们需要在此显示视图</span></div><div class="line">  renderCommon: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">//提供模板数据</span></div><div class="line">    <span class="keyword">this</span>.templateData = &#123;</div><div class="line">      <span class="string">"page-title"</span>: <span class="string">"OurPlugin"</span>,</div><div class="line">      <span class="string">"logo-class"</span>: <span class="string">""</span>,</div><div class="line">      <span class="string">"data"</span>: countlyOurplugin.getData()</div><div class="line">    &#125;;</div><div class="line"></div><div class="line">    <span class="comment">//用数据填写模板，然后将其附加到页面的内容元素</span></div><div class="line">    $(<span class="keyword">this</span>.el).html(<span class="keyword">this</span>.template(<span class="keyword">this</span>.templateData));</div><div class="line">  &#125;,</div><div class="line"></div><div class="line">  <span class="comment">//我们需要在此刷新数据</span></div><div class="line">  refresh: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</div><div class="line">    <span class="keyword">var</span> self = <span class="keyword">this</span>;</div><div class="line">    $.when(countlyOurplugin.initialize()).then(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</div><div class="line"></div><div class="line">      <span class="comment">//我们的视图未激活</span></div><div class="line">      <span class="keyword">if</span> (app.activeView != self) &#123;</div><div class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      <span class="comment">//基本上，我们需要在此执行使用 renderCommon 方法执行的操作</span></div><div class="line">      self.renderCommon();</div><div class="line">    &#125;);</div><div class="line">  &#125;</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>然后创建视图实例并将其添加到应用程序路由器的一些特定 url</p>
<ul>
<li><a href="http://resources.count.ly/v2.0/docs/plugins-frontend-client-side" target="_blank" rel="external">JavaScript</a></li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//创建视图</span></div><div class="line">app.ourpluginView = <span class="keyword">new</span> OurpluginView();</div><div class="line"></div><div class="line"><span class="comment">//注册路由</span></div><div class="line">app.route(<span class="string">'/ourplugin'</span>, <span class="string">'ourplugin'</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</div><div class="line">	<span class="keyword">this</span>.renderWhenReady(<span class="keyword">this</span>.ourpluginView);</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>执行这些操作之后，您应该能够通过 <a href="http://yourdomain.com/dashboard#/ourplugin" target="_blank" rel="external">http://yourdomain.com/dashboard#/ourplugin</a> 查看视图</p>
<h3 id="注入脚本和-html"><a href="#注入脚本和-html" class="headerlink" title="注入脚本和 html"></a>注入脚本和 html</h3><p>但是我们不想输入到 url 中，只想通过点击菜单按钮到达那里。要实现这个目的，我们可以插入 html 以呈现我们的菜单项。</p>
<p>这是加载 web 时应该完成的一次性任务，我们只需在这里等待文档就绪并将插件项添加到菜单即可。</p>
<ul>
<li><a href="http://resources.count.ly/v2.0/docs/plugins-frontend-client-side" target="_blank" rel="external">JavaScript</a></li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">$( <span class="built_in">document</span> ).ready(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">	<span class="keyword">var</span> menu = <span class="string">'&lt;a href="#/ourplugin" class="item" "&gt;'</span>+</div><div class="line">        <span class="string">'&lt;div class="logo fa fa-plugin" style="background-image:none; font-size:24px; text-align:center; width:35px; margin-left:14px; line-height:42px;"&gt;&lt;/div&gt;'</span>+</div><div class="line">        <span class="string">'&lt;div class="text" data-localize="ourplugin.title"&gt;&lt;/div&gt;'</span>+</div><div class="line">    <span class="string">'&lt;/a&gt;'</span>;</div><div class="line">	</div><div class="line">	<span class="keyword">if</span>($(<span class="string">'#management-menu'</span>).length)</div><div class="line">    <span class="comment">//是否在它之前插入管理菜单</span></div><div class="line">		$(<span class="string">'#management-menu'</span>).before(menu);</div><div class="line">	<span class="keyword">else</span></div><div class="line">    <span class="comment">//否则，在菜单末尾插入</span></div><div class="line">		$(<span class="string">'#sidebar-menu'</span>).append(menu);</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>但是，如果我们需要将 html 插入特定视图，加载页面时，它可能无法使用。我们如何了解用户是否已完成此特定视图，如果能够了解，我们就可以进行修改了。</p>
<p>我们可以添加在指定路由上执行的页面脚本。例如，每次用户访问页面 “/dashboard#/analytics/sessions” 时都将执行此脚本</p>
<ul>
<li><a href="http://resources.count.ly/v2.0/docs/plugins-frontend-client-side" target="_blank" rel="external">JavaScript</a></li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">app.addPageScript(<span class="string">"/analytics/sessions"</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</div><div class="line">   <span class="comment">//您可以在此执行任何 dom 操作</span></div><div class="line">   alert(<span class="string">"You are viewing Sessions Analytics"</span>);</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>但是，如果我们需要在每个页面视图上进行操作，情况会怎样？很简单，我们可以使用 # 作为页面脚本路由</p>
<ul>
<li><a href="http://resources.count.ly/v2.0/docs/plugins-frontend-client-side" target="_blank" rel="external">JavaScript</a></li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">app.addPageScript(<span class="string">"#"</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</div><div class="line">   <span class="comment">//您可以在此执行任何 dom 操作</span></div><div class="line">   <span class="built_in">console</span>.log(<span class="string">"new page view loaded"</span>);</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>您不清楚的动态 URL 前置会怎样？很容易！</p>
<ul>
<li><a href="http://resources.count.ly/v2.0/docs/plugins-frontend-client-side" target="_blank" rel="external">JavaScript</a></li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// URL 以 '/users/'开始后接一些字符串的所有页面，例如：</span></div><div class="line"><span class="comment">// /users/c49ebdad8f39519af9e0bfbf79332f4ec50b6d0f</span></div><div class="line">app.addPageScript(<span class="string">"/users/#"</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</div><div class="line">   <span class="built_in">console</span>.log(<span class="string">"new user profile view loaded"</span>);</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>很好，但是有些时候我们需要在视图中进行更改，但是，刷新之后又变为更改前的状态，如何解决这个问题？</p>
<p>我们可以将刷新页面脚本添加到特定路由，就像添加页面脚本一样。</p>
<ul>
<li><a href="http://resources.count.ly/v2.0/docs/plugins-frontend-client-side" target="_blank" rel="external">JavaScript</a></li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">app.addRefreshScript(<span class="string">"/analytics/sessions"</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</div><div class="line">  <span class="comment">//您可以在此执行任何 dom 操作</span></div><div class="line">	<span class="built_in">console</span>.log(<span class="string">"sessions view refreshed"</span>);</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<h3 id="处理指标数据"><a href="#处理指标数据" class="headerlink" title="处理指标数据"></a>处理指标数据</h3><p>插件的常见使用情况是添加新指标，下面我们通过示例来看一下如何显示指标数据。</p>
<p>首先还是通过模型。保存的数据和显示的数据有很大的区别，因此需要对指标数据执行不同的转化，但是，您可以使用辅助方法轻松转化。</p>
<ul>
<li><a href="http://resources.count.ly/v2.0/docs/plugins-frontend-client-side" target="_blank" rel="external">JavaScript</a></li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">CountlyHelpers.createMetricModel(<span class="built_in">window</span>.countlyOurmetric = <span class="built_in">window</span>.countlyOurmetric || &#123;&#125;, <span class="string">"ourmetric"</span>, jQuery);</div></pre></td></tr></table></figure>
<p>然后我们会创建一个视图以使用模型获取指标数据并生成饼形图和含有数据的数据表</p>
<p>因为我们会使用 Countly 中所用的默认模板，因此我们不需要加载自己的模板。</p>
<ul>
<li><a href="http://resources.count.ly/v2.0/docs/plugins-frontend-client-side" target="_blank" rel="external">JavaScript</a></li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">window</span>.OurmetricView = countlyView.extend(&#123;</div><div class="line">  <span class="comment">//初始化模型</span></div><div class="line">  beforeRender: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">    <span class="keyword">return</span> $.when(countlyOurmetric.initialize()).then(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;&#125;);</div><div class="line">  &#125;,</div><div class="line">  </div><div class="line">  <span class="comment">//显示数据</span></div><div class="line">  renderCommon:<span class="function"><span class="keyword">function</span> (<span class="params">isRefresh</span>) </span>&#123;</div><div class="line">    <span class="keyword">var</span> data = countlyOurmetric.getData();</div><div class="line"></div><div class="line">    <span class="comment">//比较模板数据</span></div><div class="line">    <span class="keyword">this</span>.templateData = &#123;</div><div class="line">      <span class="string">"page-title"</span>:jQuery.i18n.map[<span class="string">"ourmetric.title"</span>],</div><div class="line">      <span class="string">"logo-class"</span>:<span class="string">""</span>,</div><div class="line">      <span class="string">"graph-type-double-pie"</span>:<span class="literal">true</span>,</div><div class="line">      <span class="string">"pie-titles"</span>:&#123;</div><div class="line">        <span class="string">"left"</span>:jQuery.i18n.map[<span class="string">"common.total-users"</span>],</div><div class="line">        <span class="string">"right"</span>:jQuery.i18n.map[<span class="string">"common.new-users"</span>]</div><div class="line">      &#125;</div><div class="line">    &#125;;</div><div class="line"></div><div class="line">    <span class="comment">//如果首次加载且未刷新</span></div><div class="line">    <span class="keyword">if</span> (!isRefresh) &#123;</div><div class="line">      </div><div class="line">      <span class="comment">//使用数据构建模板</span></div><div class="line">      $(<span class="keyword">this</span>.el).html(<span class="keyword">this</span>.template(<span class="keyword">this</span>.templateData));</div><div class="line"></div><div class="line">      <span class="comment">//使用图表数据创建数据表</span></div><div class="line">      <span class="keyword">this</span>.dtable = $(<span class="string">'.d-table'</span>).dataTable($.extend(&#123;&#125;, $.fn.dataTable.defaults, &#123;</div><div class="line">        <span class="comment">//为数据表提供数据</span></div><div class="line">        <span class="string">"aaData"</span>: data.chartData,</div><div class="line">        </div><div class="line">        <span class="comment">//指定要显示的列</span></div><div class="line">        <span class="string">"aoColumns"</span>: [</div><div class="line">          &#123; <span class="string">"mData"</span>: <span class="string">"ourmetric"</span>, <span class="attr">sType</span>:<span class="string">"session-duration"</span>, <span class="string">"sTitle"</span>: jQuery.i18n.map[<span class="string">"ourmetric.title"</span>] &#125;,</div><div class="line">          &#123; <span class="string">"mData"</span>: <span class="string">"t"</span>, <span class="attr">sType</span>:<span class="string">"formatted-num"</span>, <span class="string">"mRender"</span>:<span class="function"><span class="keyword">function</span>(<span class="params">d</span>) </span>&#123; <span class="keyword">return</span> countlyCommon.formatNumber(d); &#125;, <span class="string">"sTitle"</span>: jQuery.i18n.map[<span class="string">"common.table.total-sessions"</span>] &#125;,</div><div class="line">          &#123; <span class="string">"mData"</span>: <span class="string">"u"</span>, <span class="attr">sType</span>:<span class="string">"formatted-num"</span>, <span class="string">"mRender"</span>:<span class="function"><span class="keyword">function</span>(<span class="params">d</span>) </span>&#123; <span class="keyword">return</span> countlyCommon.formatNumber(d); &#125;, <span class="string">"sTitle"</span>: jQuery.i18n.map[<span class="string">"common.table.total-users"</span>] &#125;,</div><div class="line">          &#123; <span class="string">"mData"</span>: <span class="string">"n"</span>, <span class="attr">sType</span>:<span class="string">"formatted-num"</span>, <span class="string">"mRender"</span>:<span class="function"><span class="keyword">function</span>(<span class="params">d</span>) </span>&#123; <span class="keyword">return</span> countlyCommon.formatNumber(d); &#125;, <span class="string">"sTitle"</span>: jQuery.i18n.map[<span class="string">"common.table.new-users"</span>] &#125;</div><div class="line">         ]</div><div class="line">       &#125;));</div><div class="line">      </div><div class="line">      <span class="comment">//创建黏着式表标题</span></div><div class="line">      $(<span class="string">".d-table"</span>).stickyTableHeaders();</div><div class="line">       </div><div class="line">      <span class="comment">//绘出总数据图表</span></div><div class="line">      countlyCommon.drawGraph(data.chartDPTotal, <span class="string">"#dashboard-graph"</span>, <span class="string">"pie"</span>);</div><div class="line">      </div><div class="line">      <span class="comment">//绘出新数据图表</span></div><div class="line">      countlyCommon.drawGraph(data.chartDPNew, <span class="string">"#dashboard-graph2"</span>, <span class="string">"pie"</span>);</div><div class="line">    &#125;</div><div class="line">  &#125;,</div><div class="line">  </div><div class="line">  <span class="comment">//正在刷新图表</span></div><div class="line">  refresh:<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</div><div class="line">    <span class="keyword">var</span> self = <span class="keyword">this</span>;</div><div class="line">    $.when(countlyOurmetric.refresh()).then(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</div><div class="line">      </div><div class="line">      <span class="comment">//不是视图</span></div><div class="line">      <span class="keyword">if</span> (app.activeView != self) &#123;</div><div class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</div><div class="line">      &#125;</div><div class="line">      </div><div class="line">      <span class="comment">//填写并重新生成模板数据</span></div><div class="line">      self.renderCommon(<span class="literal">true</span>);</div><div class="line"></div><div class="line">      <span class="comment">//将视图中的现有元素替换为新数据</span></div><div class="line">      newPage = $(<span class="string">"&lt;div&gt;"</span> + self.template(self.templateData) + <span class="string">"&lt;/div&gt;"</span>);  </div><div class="line">       $(self.el).find(<span class="string">".dashboard-summary"</span>).replaceWith(newPage.find(<span class="string">".dashboard-summary"</span>));</div><div class="line">      </div><div class="line">      <span class="keyword">var</span> data = countlyOurmetric.getData();</div><div class="line">      </div><div class="line">      <span class="comment">//刷新图表</span></div><div class="line">      countlyCommon.drawGraph(data.chartDPTotal, <span class="string">"#dashboard-graph"</span>, <span class="string">"pie"</span>);</div><div class="line">      countlyCommon.drawGraph(data.chartDPNew, <span class="string">"#dashboard-graph2"</span>, <span class="string">"pie"</span>);</div><div class="line">      </div><div class="line">      <span class="comment">//刷新数据表</span></div><div class="line">      CountlyHelpers.refreshTable(self.dtable, data.chartData);</div><div class="line">    &#125;);</div><div class="line">  &#125;</div><div class="line">&#125;);</div><div class="line"></div><div class="line"><span class="comment">//创建视图</span></div><div class="line">app.ourmetricView = <span class="keyword">new</span> OurmetricView();</div><div class="line"></div><div class="line"><span class="comment">//注册路由</span></div><div class="line">app.route(<span class="string">"/analytics/ourmetric"</span>, <span class="string">'ourmetric'</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</div><div class="line">  <span class="keyword">this</span>.renderWhenReady(<span class="keyword">this</span>.ourmetricView);</div><div class="line">&#125;);</div><div class="line"></div><div class="line"><span class="comment">//添加菜单项</span></div><div class="line">$( <span class="built_in">document</span> ).ready(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">  <span class="keyword">var</span> menu = <span class="string">'&lt;a href="#/analytics/ourmetric" class="item"&gt;'</span>+</div><div class="line">    <span class="string">'&lt;div class="logo"&gt;&lt;/div&gt;'</span>+</div><div class="line">    <span class="string">'&lt;div class="text" data-localize="ourmetric.title"&gt;&lt;/div&gt;'</span>+</div><div class="line">  <span class="string">'&lt;/a&gt;'</span>;</div><div class="line">  $(<span class="string">'#analytics-submenu'</span>).append(menu);</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>我们已将新指标添加到 Countly 安装和其他 API 部分示例，这样，我们便可以与其他人共享插件。</p>
<p>现在我们只需修改 Countly SDK 安装以将我们的自定义指标报告给服务器，即可完成所有操作。</p>
<h2 id="扩展或修改模块"><a href="#扩展或修改模块" class="headerlink" title="扩展或修改模块"></a>扩展或修改模块</h2><p>所有之前的页面都会显示如何将新功能添加到 Countly。但如果您要修改现有行为会怎样？最好的方法就是直接修改模块。</p>
<p>例如，<strong>countly/api/parts/mgmt</strong> 中的 <strong>mail.js</strong> 模块。如果我们要更改 Countly 默认发送的模板电子邮件会怎样？可以允许我们的插件通过插件管理器修改此模块。这样，需要此模块的任何实例或流程都可以通过我们之前的修改。</p>
<p>那么，我们如何能实现此目标？</p>
<p>首先，我们需要修改 mail.js 模块本身。<br>实际上已对部分模块进行修改以备扩展，因此，如果您需要对那些尚未扩展的模块进行扩展，可以执行以下操作：</p>
<ul>
<li><a href="http://resources.count.ly/v2.0/docs/extending-or-modifying-modules" target="_blank" rel="external">JavaScript</a></li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//需要插件管理器</span></div><div class="line"><span class="keyword">var</span> plugins = <span class="built_in">require</span>(<span class="string">'../../../plugins/pluginManager.js'</span>);</div><div class="line"></div><div class="line"><span class="comment">//扩展模块名为“邮件”的模块和模块对象模块</span></div><div class="line">plugins.extendModule(<span class="string">"mail"</span>, mail);</div><div class="line"></div><div class="line"><span class="comment">//然后仅进行传输以将其导出</span></div><div class="line"><span class="built_in">module</span>.exports = mail;</div></pre></td></tr></table></figure>
<blockquote>
<h3 id="扩展其他模块"><a href="#扩展其他模块" class="headerlink" title="扩展其他模块"></a>扩展其他模块</h3><p>目前 mail.js 模块已经修改并且可以扩展，如果您需要修改任何其他模块，您需要进行这些更改。您还可以将 PR 更改提交到我们的存储库，以便更改会对所有 Countly 安装生效。</p>
</blockquote>
<p>这就是我们通过插件管理器来扩展模块对象。但里面到底发生了什么，我们实际上是如何修改的？</p>
<p>实际上插件管理器遍历所有插件，并检查插件的 extend 文件夹中是否有 mail 模块。</p>
<p>要扩展 mail.js，您需要扩展插件中含有 mail.js 的文件夹。</p>
<p>标准插件结构如下：</p>
<ul>
<li><a href="http://resources.count.ly/v2.0/docs/extending-or-modifying-modules" target="_blank" rel="external">Text</a></li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line">│   install.js</div><div class="line">│   package.json</div><div class="line">│   tests.js</div><div class="line">│   uninstall.js</div><div class="line">│</div><div class="line">├───api</div><div class="line">│       api.js</div><div class="line">│</div><div class="line">├───extend</div><div class="line">│       mail.js</div><div class="line">│</div><div class="line">└───frontend</div><div class="line">    │   app.js</div><div class="line">    │</div><div class="line">    └───public</div><div class="line">        ├───images</div><div class="line">        │   └───empty</div><div class="line">        │           image1.png</div><div class="line">        │           image2.png</div><div class="line">        │</div><div class="line">        ├───javascripts</div><div class="line">        │       countly.models.js</div><div class="line">        │       countly.views.js</div><div class="line">        │</div><div class="line">        ├───localization</div><div class="line">        │       empty.properties</div><div class="line">        │</div><div class="line">        ├───stylesheets</div><div class="line">        │       main.css</div><div class="line">        │</div><div class="line">        └───templates</div><div class="line">                tempalte2.html</div><div class="line">                template1.html</div></pre></td></tr></table></figure>
<p>此 mail.js 的内容应该导出待调用的函数，从而接收邮件对象并进行修改。例如：</p>
<ul>
<li><a href="http://resources.count.ly/v2.0/docs/extending-or-modifying-modules" target="_blank" rel="external">JavaScript</a></li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">module.exports = function(mail)&#123;</div><div class="line">    mail.sendPasswordResetInfo = function (member, prid) &#123;</div><div class="line">        var message = &#123;</div><div class="line">            to: member.email,</div><div class="line">            subject: 'Let's reset your password ok',</div><div class="line">            html:'Hello,&lt;br/&gt;&lt;br/&gt;'+</div><div class="line">                'So '+ member.full_name + ', did you forget your password?'</div><div class="line">        &#125;;</div><div class="line">    </div><div class="line">        mail.sendMail(message);</div><div class="line">    &#125;;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>我们已通过此方法对要发送给请求密码更改的成员的电子邮件进行了更改，因为导出项目之前，请求此模块的每个流程（api 或前端）都会通过插件管理器中的修改。</p>
<p>但正如先前所说，它还可以应用于其他模块。</p>
<h2 id="共享配置"><a href="#共享配置" class="headerlink" title="共享配置"></a>共享配置</h2><p>如果需要为插件保存特定配置并在每次请求时使用（甚至可能希望允许用户更改配置值），在此情况下您可以使用共享文档保存配置。</p>
<p>由于共享配置存储在数据库中，因此会在 api 和前端侧、不同 cpu 核心多个进程和多个服务器实例之间共享。</p>
<h3 id="设置配置"><a href="#设置配置" class="headerlink" title="设置配置"></a>设置配置</h3><p>开始使用共享文档很简单，只需调用 <strong>plugins.setConfigs </strong>方式并为配置传入插件命名空间和默认值。</p>
<ul>
<li><a href="http://resources.count.ly/v2.0/docs/logging" target="_blank" rel="external">JavaScript</a></li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> plugins = <span class="built_in">require</span>(<span class="string">'../plugins/pluginManager.js'</span>);</div><div class="line"></div><div class="line">plugins.setConfigs(<span class="string">"ourplugin"</span>, &#123;</div><div class="line">    <span class="attr">config1</span>: <span class="string">"value1"</span>,</div><div class="line">    <span class="attr">config2</span>: <span class="literal">false</span>,</div><div class="line">    <span class="attr">config3</span>: <span class="number">120</span></div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>您应尽快完成此操作（最好是在加载 plugins manager 之后）。您可以在 api 侧或前端侧使用（配置将存储在数据库中并在进程之间共享，因此在任意一侧设置都不会产生影响）。</p>
<p>默认情况下，所有配置均可在配置的 Web 用户界面中查看和更改。如果不希望配置出现在 Web 用户界面中，需要让第三个参数为 <strong>true</strong>。</p>
<ul>
<li><a href="http://resources.count.ly/v2.0/docs/logging" target="_blank" rel="external">JavaScript</a></li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">plugins.setConfigs(<span class="string">"ourplugin_hidden"</span>, &#123;</div><div class="line">    <span class="attr">config1</span>: <span class="string">"value1"</span>,</div><div class="line">    <span class="attr">config2</span>: <span class="literal">false</span>,</div><div class="line">    <span class="attr">config3</span>: <span class="number">120</span></div><div class="line">&#125;, <span class="literal">true</span>);</div></pre></td></tr></table></figure>
<p>您可以为插件使用多个命名空间，只需确保不与其他插件命名空间发生冲突即可，因此至少尝试使用插件名称为其添加前缀。</p>
<h3 id="获取配置值"><a href="#获取配置值" class="headerlink" title="获取配置值"></a>获取配置值</h3><p>由于配置值可能发生更改（用户在配置用户界面更改或其他服务器实例更改），因此<strong>不</strong>建议加载配置一次并在之后进行使用。</p>
<p>最好在每次请求时加载配置（同一请求期间可以确保未发生更改，但可能在不同请求之间发生变更），甚至可以按需要加载，使用 getConfig 方式并提供命名空间。</p>
<p>极少数情况下配置无法加载，getConfig 方式确保至少提供空对象，因此您可以轻松恢复默认值。</p>
<ul>
<li><a href="http://resources.count.ly/v2.0/docs/logging" target="_blank" rel="external">JavaScript</a></li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> somevalue = plugins.getConfig(<span class="string">"ourplugin"</span>).config1 || default_value;</div></pre></td></tr></table></figure>
<h3 id="更新配置"><a href="#更新配置" class="headerlink" title="更新配置"></a>更新配置</h3><p>如果出于某些原因需要更新配置，可在下一进程开始时将其添加至 <strong>setConfigs</strong> 方法，该方法将获取旧配置中不存在的新值。</p>
<p>但如果不想等到下一进程开始，比如为不同应用存储不同属性，现在新应用已添加并且要更新配置添加新应用属性。您也可以使用 <strong>updateConfigs</strong> 方法直接更新配置，其中需要传入要添加的数据库对象、命名空间和新属性。</p>
<ul>
<li><a href="http://resources.count.ly/v2.0/docs/logging" target="_blank" rel="external">JavaScript</a></li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//for example we have an object as</span></div><div class="line">plugins.setConfigs(<span class="string">"ourplugin"</span>, &#123;</div><div class="line">  <span class="attr">ob1</span>:&#123;</div><div class="line">    <span class="attr">subob1</span>:&#123;</div><div class="line">      <span class="attr">prop1</span>:<span class="string">"value1"</span></div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="comment">//if we want to add prop2 to subob1, then we update configs like this</span></div><div class="line">plugins.updateConfigs(common.db, <span class="string">"ourplugin"</span>, &#123;<span class="attr">ob1</span>:&#123;<span class="attr">subob1</span>:&#123;<span class="attr">prop2</span>:<span class="string">"value2"</span>&#125;&#125;&#125;, <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</div><div class="line">  <span class="comment">//config updated</span></div><div class="line">  <span class="built_in">console</span>.log(<span class="string">"done"</span>);</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>之后配置将更新，新值在下次请求时可用。</p>
<h3 id="配置的-Web-用户界面"><a href="#配置的-Web-用户界面" class="headerlink" title="配置的 Web 用户界面"></a>配置的 Web 用户界面</h3><p>插件管理程序也会自动生成用户界面（如果配置未排除），允许全局管理员更改您提供的配置。将检查您的数据类型并提供布尔值开关、用于数字的 HTML5 数字输入以及用于文本值的文本输入。</p>
<p><img src="https://files.readme.io/9T8s3S1IRxiZxlDJ8Foa_configurations.png" alt="img"></p>
<h3 id="自定义-Web-用户界面输入"><a href="#自定义-Web-用户界面输入" class="headerlink" title="自定义 Web 用户界面输入"></a>自定义 Web 用户界面输入</h3><p>但您也可以隐藏特定配置键或为插件配置选项提供自定义输入类型。</p>
<p>您可以在文档加载后使用 <strong>configurationView</strong> 的 <strong>registerInput</strong> 函数。您需要为配置值提供“路径”（使用短划线分隔），返回 null 隐藏值或返回 HTML 代码替换标准输入。</p>
<p>如果设置此配置，例如：</p>
<ul>
<li><a href="http://resources.count.ly/v2.0/docs/logging" target="_blank" rel="external">JavaScript</a></li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">plugins.setConfigs(<span class="string">"ourplugin"</span>, &#123;</div><div class="line">  	<span class="attr">subobject</span>:&#123;</div><div class="line">      <span class="attr">subproperty</span>:<span class="number">10</span></div><div class="line">    &#125;,</div><div class="line">    <span class="attr">config1</span>: <span class="string">"value1"</span>,</div><div class="line">    <span class="attr">config2</span>: <span class="literal">false</span>,</div><div class="line">    <span class="attr">config3</span>: <span class="number">120</span></div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>输入中隐藏子对象的子属性，请注册以下函数：</p>
<ul>
<li><a href="http://resources.count.ly/v2.0/docs/logging" target="_blank" rel="external">JavaScript</a></li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">$( <span class="built_in">document</span> ).ready(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">  <span class="comment">//check if configuration view exists</span></div><div class="line">  <span class="keyword">if</span>(app.configurationsView)&#123;</div><div class="line">    app.configurationsView.registerInput(<span class="string">"ourplugin-subobject-subproperty"</span>, <span class="function"><span class="keyword">function</span>(<span class="params">value</span>)</span>&#123;</div><div class="line">      <span class="comment">//no html for this input, will hide it</span></div><div class="line">			<span class="keyword">return</span> <span class="literal">null</span>;</div><div class="line">		&#125;);</div><div class="line">  &#125;</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>但要覆盖 config1 默认文本输入，需要先为自定义输入提供 HTML 代码（当然还需要确定所需格式）</p>
<ul>
<li><a href="http://resources.count.ly/v2.0/docs/logging" target="_blank" rel="external">JavaScript</a></li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">$( <span class="built_in">document</span> ).ready(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">  <span class="comment">//check if configuration view exists</span></div><div class="line">  <span class="keyword">if</span>(app.configurationsView)&#123;</div><div class="line">    app.configurationsView.registerInput(<span class="string">"ourplugin-config1"</span>, <span class="function"><span class="keyword">function</span>(<span class="params">value</span>)</span>&#123;</div><div class="line">      <span class="comment">//return HTML code to textarea</span></div><div class="line">			<span class="keyword">return</span> <span class="string">"&lt;textarea id='ourplugin-config1' class='mytextarestyle'&gt;"</span>+value+<span class="string">"&lt;/textarea&gt;"</span>;</div><div class="line">		&#125;);</div><div class="line">  &#125;</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>处理期间更改值并设置到配置视图 <strong>updateConfig</strong> 方式</p>
<ul>
<li><a href="http://resources.count.ly/v2.0/docs/logging" target="_blank" rel="external">JavaScript</a></li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">app.addPageScript(<span class="string">"/manage/configurations"</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</div><div class="line">   <span class="keyword">if</span>(app.configurationsView)&#123;</div><div class="line">     	$(<span class="string">"#ourplugin-config1"</span>).keyup(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</div><div class="line">        <span class="comment">//value might have changed</span></div><div class="line">     		<span class="keyword">var</span> id = $(<span class="keyword">this</span>).attr(<span class="string">"id"</span>);</div><div class="line">      	<span class="keyword">var</span> value = $(<span class="keyword">this</span>).val();</div><div class="line">        <span class="comment">//let's notify configuration view about possible changes</span></div><div class="line">				app.configurationsView.updateConfig(id, value);</div><div class="line">			&#125;);</div><div class="line">   &#125;</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<h3 id="自定义-Web-用户界面标签"><a href="#自定义-Web-用户界面标签" class="headerlink" title="自定义 Web 用户界面标签"></a>自定义 Web 用户界面标签</h3><p>与输入类似，您也可以为标签提供自定义 HTML，包括译为当前语言和提供帮助提示信息等。</p>
<p>要覆盖默认标签名称，只需使用<strong>configurationView</strong> 的 <strong>registerLabe</strong>l 方式并传入 id 和 html 代码替换。</p>
<ul>
<li><a href="http://resources.count.ly/v2.0/docs/logging" target="_blank" rel="external">JavaScript</a></li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">$( <span class="built_in">document</span> ).ready(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">  <span class="comment">//check if configuration view exists</span></div><div class="line">  <span class="keyword">if</span>(app.configurationsView)&#123;</div><div class="line">    app.configurationsView.registerLabel(<span class="string">"ourplugin-subobject-subproperty"</span>, </div><div class="line">        <span class="string">"&lt;span class='help-zone-vs' data-help-localize='ourplugin.help.subproperty'&gt;Subproperty&lt;/span&gt;"</span>);</div><div class="line">  &#125;</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<h3 id="插件特定配置页面"><a href="#插件特定配置页面" class="headerlink" title="插件特定配置页面"></a>插件特定配置页面</h3><p>如要在插件视图中提供编辑设置按钮并将用户引导至插件特定配置页面（使用仅用于特定插件命名空间的选项），您可将该按钮指向<strong>“#/manage/configurations/namespace”</strong>（当然需要替换为您的配置命名空间）。</p>
<p>用户将重定向至仅包含该命名空间配置的页面、能够进行更改并使用返回按钮返回插件视图。</p>
<p><img src="https://files.readme.io/AiWQGYktR9C8Yg2V3eLE_namespace-config.png" alt="img"></p>
<h2 id="日志记录"><a href="#日志记录" class="headerlink" title="日志记录"></a>日志记录</h2><p>Countly采用集中式日志记录系统。该系统确保一致的日志记录，并具有改变记录仪活动的能力。</p>
<p>要使用Countly日志记录，您需要：</p>
<p>1。通过启动<code>common.log(“LOGGER_NAME”)</code> 实例化一个记录仪，其中“Common”的是<code>API/utils/common.js</code>模块。您需要通过插件组件名称提供插件名称如“Users”或“Users：API”替换<code>LOGGER_NAME</code></p>
<p>2。采用记录仪的功能之一：<code>d</code>，<code>i</code>，<code>w</code>，<code>e</code>。每个功能代表一个不同的日志记录级别：DEBUG，INFO，WARNING，ERROR分别。这些功能参数和<code>console.log</code>相同。</p>
<p>请查看以下的插件例子：</p>
<ul>
<li><a href="http://resources.count.ly/v2.0/docs/logging" target="_blank" rel="external">JavaScript</a></li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> plugin = &#123;&#125;,</div><div class="line"> 	common = <span class="built_in">require</span>(<span class="string">'../../../api/utils/common.js'</span>),</div><div class="line"> 	log = common.log(<span class="string">'flows:api'</span>),</div><div class="line"> 	plugins = <span class="built_in">require</span>(<span class="string">'../../pluginManager.js'</span>);</div><div class="line"> </div><div class="line">plugins.setConfigs(<span class="string">'myPlugin'</span>, &#123;</div><div class="line"> 	<span class="attr">someConfigurationOption</span>: <span class="number">5</span>,</div><div class="line">&#125;);</div><div class="line"> </div><div class="line">(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</div><div class="line"> </div><div class="line"> 	plugins.register(<span class="string">'/i'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">ob</span>)</span>&#123;</div><div class="line">      	<span class="keyword">var</span> params = ob.params;</div><div class="line">      	log.i(<span class="string">'myPlugin got a request: %j'</span>, params.qstring);</div><div class="line"> 	&#125;);</div><div class="line"> </div><div class="line">&#125;)(plugin);</div></pre></td></tr></table></figure>
<h3 id="日志记录配置"><a href="#日志记录配置" class="headerlink" title="日志记录配置"></a>日志记录配置</h3><p>主要日志记录配置是在管理菜单的配置部分：</p>
<p><img src="https://files.readme.io/74wyazSPQ5mgSisJVTPG_Screenshot-2015-10-15-17.31.04.png" alt="img"></p>
<p>日志记录的配置包括记录仪名称逗号分隔的列表。记录仪默认值是未在配置中列出日志记录级别。要覆写日志记录级别<code>WARNING</code>的模块<code>api</code>并将其设置为’DEBUG<code>，你需要在以上图面用</code>pushly，api<code>替换&#39;pushly</code>。这将自动启用所有<code>API：XXX</code>记录仪，除非有一些配置不同的日志级别。</p>
<p>另外注意，Countly启动时不提供这种配置，默认日志记录配置也必须提供给<code>config.js</code>。 <code>config.js</code>首选项用于启动，然后被存储在MongoDB中共享的配置替换：</p>
<ul>
<li><a href="http://resources.count.ly/v2.0/docs/logging" target="_blank" rel="external">JavaScript</a></li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> countlyConfig = &#123;</div><div class="line">    ...</div><div class="line">    logging: &#123;</div><div class="line">        <span class="attr">info</span>: [<span class="string">"jobs"</span>],</div><div class="line">        <span class="attr">default</span>: <span class="string">"warning"</span></div><div class="line">    &#125;</div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="built_in">module</span>.exports = countlyConfig;</div></pre></td></tr></table></figure>
<h2 id="文档拆分"><a href="#文档拆分" class="headerlink" title="文档拆分"></a>文档拆分</h2><p>指南如何使用拆分包含大量数据的文档</p>
<p>MongoDB有一个文档大小限制，这是绑定到BSON对象大小限制，它是16Mb每个文档。 </p>
<p>即使没有达到限制，根据您对文档的写入量，当文档变大时，写入速度也会变慢。 </p>
<p>因此，有一种文档分割技术，它类似于MongoDB分片，但通过逻辑分割数据在本地进行工作。 </p>
<p>我们在所有指标集合以及事件和用户集合上使用此技术。由于我们正在计算每个指标或用户的总计，因此我们需要确保相同的指标和同一用户总是进入同一个文档。</p>
<p> 因此，例如，当一个运营商指标值出现时，我们取值，使用md5对其进行哈希，在base64中对其进行编码，并获取第一个符号。 </p>
<p>然后我们将这个符号附加到我们将这个指标的集合的id。这样我们几乎平均地将传入指标分为64个拆分文档。</p>
<ul>
<li><a href="http://resources.count.ly/v2.0/docs/document-splitting" target="_blank" rel="external">JavaScript的</a></li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> crypto = <span class="built_in">require</span>(<span class="string">"crypto"</span>);</div><div class="line"></div><div class="line"><span class="keyword">var</span> carrier = <span class="string">"AT&amp;T"</span>;</div><div class="line"></div><div class="line"><span class="keyword">var</span> postfix = crypto.createHash(<span class="string">"md5"</span>).update(carrier).digest(<span class="string">'base64'</span>)[<span class="number">0</span>];</div><div class="line"></div><div class="line"><span class="keyword">var</span> id = app_id+<span class="string">"_2016:0_"</span>+postfix;</div><div class="line"></div><div class="line">common.db.collection(<span class="string">"carriers"</span>).update(&#123;<span class="attr">_id</span>:id&#125;, &#123;<span class="attr">$set</span>:someUpdate&#125;, &#123;<span class="attr">upsert</span>:<span class="literal">true</span>&#125;, <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;&#125;);</div></pre></td></tr></table></figure>
<p>每个文档的结构与在单个文档中正常使用时的结构完全相同。 然后只有区别在于，相同的数据被分割到多个文档，每个写入发生在一个较小的文档。</p>
<p>当然，当获取数据时，我们需要获取所有64个文档并将数据合并在一起。 它仍然优于大型文档的写入时间。</p>
<ul>
<li><a href="http://resources.count.ly/v2.0/docs/document-splitting" target="_blank" rel="external">JavaScript的</a></li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> base_id = app_id+<span class="string">"_2016:0"</span>;</div><div class="line"><span class="keyword">var</span> docs = [];</div><div class="line"></div><div class="line"><span class="comment">//common.base64 is just an array of all possible symbols from 64 alphabet, as</span></div><div class="line"><span class="comment">//["0","1","2","3","4","5","6","7","8","9","a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z","A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z","+","/"];</span></div><div class="line"></div><div class="line"><span class="keyword">for</span>(<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; common.base64.length; i++)&#123;</div><div class="line">	docs.push(base_id+<span class="string">"_"</span>+common.base64[i]);</div><div class="line">&#125;</div><div class="line"></div><div class="line">common.db.collection(<span class="string">"carriers"</span>).find(&#123;<span class="attr">_id</span>:&#123;<span class="attr">$in</span>: docs&#125;&#125;).toArray(<span class="function"><span class="keyword">function</span>(<span class="params">err, res</span>)</span>&#123;</div><div class="line">	<span class="comment">//merge data</span></div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>我们只是通过加权所有属性来合并它们。</p>
<h2 id="调试countly服务器"><a href="#调试countly服务器" class="headerlink" title="调试countly服务器"></a>调试countly服务器</h2><p>这是一个关于如何调试Countly服务器的小指南。</p>
<blockquote>
<p> <strong>NodeJS版本</strong></p>
<p> 最低支持的NodeJS版本为6.3.0。</p>
<p> <strong>需要Chrome</strong></p>
<p> 此功能需要Chrome浏览器才能运行。</p>
</blockquote>
<p>由于调试功能需要至少6.3.0的Nodejs，所以这只能在Countly版本16.12+上。</p>
<p>您可能可以在不同于Chrome的运行调试器，只要它有chrome-devtools。</p>
<h3 id="修改服务器配置"><a href="#修改服务器配置" class="headerlink" title="修改服务器配置"></a>修改服务器配置</h3><p>第一步是修改Countly服务器<code>supervisord.conf</code>配置文件，<code>Countly/bin/config/</code>以支持调试。我们需要在node server startup命令中添加“–inspect”参数。您还可以设置“–debug-brk”参数，调试器将在服务器脚本的第一个语句上停止。<br>在这个例子中，我使用winscp从windows更改配置文件，但你可以使用任何工具最适合你。</p>
<p><img src="https://files.readme.io/befce7d-t1.PNG" alt="img"></p>
<p>您还应该设置服务器仅使用1个工作线程，否则您要调试的代码将运行在您将检查的不同线程中。您应该编辑<code>config.js</code>文件中找到的文件<code>Countly/api/</code>。</p>
<p><img src="https://files.readme.io/f9b5343-t2.PNG" alt="img"></p>
<p>配置完成后，您需要通过调用重新启动服务器<code>countly restart</code>。</p>
<p><img src="https://files.readme.io/e2957bd-t3.PNG" alt="img"></p>
<h3 id="运行调试环境"><a href="#运行调试环境" class="headerlink" title="运行调试环境"></a>运行调试环境</h3><p>重新启动服务器后，应打开仪表板中的错误日志或打开“countly / log / countly-api.log”中的服务器上的日志文件。在那里你应该看到提供调试的url。使用每次重新启动服务器时提供的最后一个。</p>
<p><img src="https://files.readme.io/2abdf46-t4.PNG" alt="img"></p>
<p>提供的网址应类似于“chrome-devtools://devtools/remote/serve_file/@60cd6e859b9f557d2312f5bf532f6aec5f284980/inspector.html?experiments = true&amp;v8only = true&amp;ws=127.0.0.1:5859 / 8c8a73e5-16b2-4aec-8a51-fee495578​​558”。下一步取决于您要调试的NodeJS服务器是本地还是远程。如果您在本地托管服务器，则不需要进行更改。如果服务器是远程的或托管在本地VM上，则应将“127.0.0.1”替换为服务器IP地址或域名。</p>
<p>您应该将生成的字符串粘贴到您的Chrome或其他兼容的浏览器。它应该在“控制台”选项卡上打开。</p>
<p><img src="https://files.readme.io/c21b701-t5.PNG" alt="img"></p>
<p>“源”选项卡应类似于以下内容：</p>
<p><img src="https://files.readme.io/d55eae7-t6.PNG" alt="img"></p>
<h3 id="改进工作流程"><a href="#改进工作流程" class="headerlink" title="改进工作流程"></a>改进工作流程</h3><p>您可能已经在调试工作流程中注意到了一个小小的障碍。每次对后端进行某些更改时，都需要重新启动服务器。每次重新启动服务器时，都会得到一个新的调试网址。如果你有一个远程服务器，那么每次你还需要替换服务器地址。它变得相当乏味，使调试体验更糟糕，因此应该是。</p>
<p>此问题的解决方案是名为<a href="https://chrome.google.com/webstore/detail/nim-node-inspector-manage/gnhhdgbaldcilmgcpfddgdbkhjohddkj" target="_blank" rel="external">“NIM（Node Inspector Manager）”</a>的chrome插件</p>
<p><a href="https://files.readme.io/6c65eff-t7.png" target="_blank" rel="external"><img src="https://files.readme.io/6c65eff-t7.png" alt="img"></a></p>
<p>如果您正确设置了NIM，它应该在每次使用“countly restart”重新启动节点服务器时打开正确的URL。</p>
<h3 id="使用调试环境"><a href="#使用调试环境" class="headerlink" title="使用调试环境"></a>使用调试环境</h3><p>您很快就会注意到，首先不是所有的.js文件都在侧面板中可用，但在使用一些端点或打开一些仪表板页面后，它们变得可见。这些文件是动态加载的。但是一旦你加载它们，你可以在中间打开它们，并让它们可用的所有时间。</p>
<p>这个chrome开发工具类似于任何其他调试器。你可以放置断点，遍历代码和查看值。</p>
<p>你点击行号来放置断点。您可以将鼠标悬停在变量上查看其内容。</p>
<p><a href="https://files.readme.io/4b95eeb-t8.png" target="_blank" rel="external"><img src="https://files.readme.io/4b95eeb-t8.png" alt="img"></a></p>
<p>在右上角你可以控制当你在断点。通过悬停在你可以看到他们的捷径。例如，F8用于恢复，F10用于跳过，F11用于语句。</p>

      

      
    </div>
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags"></i>
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Countly/">Countly</a></li></ul>
	</div>

      

      
        <p class="article-more-link">
          <a class="article-more-a" href="/2017/02/08/Countly服务器端源码分析/">展开全文 >></a>
        </p>
      

      
      <div class="clearfix"></div>
    </div>
  </div>
</article>








  
    <article id="post-SPA前后端分离下的webpack工作流" class="article article-type-post  article-index" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/01/19/SPA前后端分离下的webpack工作流/">SPA前后端分离下的webpack工作流</a>
    </h1>
  

        <a href="/2017/01/19/SPA前后端分离下的webpack工作流/" class="archive-article-date">
  	<time datetime="2017-01-19T01:49:39.000Z" itemprop="datePublished"><i class="icon-calendar icon"></i>2017-01-19</time>
</a>
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="前后端同构"><a href="#前后端同构" class="headerlink" title="前后端同构"></a>前后端同构</h3><ul>
<li>直接在后端集成webpack热加载模块（express、koa均有类似中间件）</li>
<li>优势，无需开启两个服务，无需前端服务代理中转，易实现spa的服务器端渲染</li>
<li>劣势，适用性差，增加后端开发复杂度，不适合初学者，易出错</li>
<li>实现<ul>
<li>使用<code>webpack、webpack-dev-middleware、webpack-hot-middleware</code>等模块</li>
</ul>
</li>
</ul>
<h3 id="前后端异构"><a href="#前后端异构" class="headerlink" title="前后端异构"></a>前后端异构</h3><ul>
<li>spa前端单独开启一个服务，处理静态页面请求和中转后端数据api</li>
<li>后端可以处理静态页面和数据api，逻辑清晰简单，易于集成发布</li>
<li>后端可以微服务化，可以应对大型复杂spa</li>
<li>实现<ul>
<li>使用<code>webpack-dev-server</code>前端服务，配置devServer和proxy</li>
<li>自行实现dev server，使用<code>http-proxy-middleware</code></li>
</ul>
</li>
</ul>

      

      
    </div>
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags"></i>
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/SPA/">SPA</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/webpack/">webpack</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/全栈/">全栈</a></li></ul>
	</div>

      

      
        <p class="article-more-link">
          <a class="article-more-a" href="/2017/01/19/SPA前后端分离下的webpack工作流/">展开全文 >></a>
        </p>
      

      
      <div class="clearfix"></div>
    </div>
  </div>
</article>








  
    <article id="post-Mysql任意时间范围内按任意时段分组" class="article article-type-post  article-index" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/01/18/Mysql任意时间范围内按任意时段分组/">Mysql任意时间范围内按任意时段分组</a>
    </h1>
  

        <a href="/2017/01/18/Mysql任意时间范围内按任意时段分组/" class="archive-article-date">
  	<time datetime="2017-01-18T08:16:07.000Z" itemprop="datePublished"><i class="icon-calendar icon"></i>2017-01-18</time>
</a>
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>上代码：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">set @timeBegin=&apos;2017-01-17 00:00:00&apos;;</div><div class="line">set @interval=60*10;</div><div class="line">select FROM_UNIXTIME(FLOOR(UNIX_TIMESTAMP(`BUYTIME`)/@interval)*@interval) as timeNearTo, count(*) as &apos;count&apos; </div><div class="line">from wg_device_sale</div><div class="line">where BUYTIME&gt;=@timeBegin AND BUYTIME&lt;=DATE_ADD(@timeBegin,INTERVAL 1 DAY)</div><div class="line">group by timeNearTo </div><div class="line">order by timeNearTo desc;</div></pre></td></tr></table></figure></p>
<p>结果：</p>
<table>
<thead>
<tr>
<th>timeNearTo</th>
<th>count</th>
</tr>
</thead>
<tbody>
<tr>
<td>2017-01-17 23:00:00</td>
<td>6</td>
</tr>
<tr>
<td>2017-01-17 23:30:00</td>
<td>1</td>
</tr>
<tr>
<td>2017-01-17 22:30:00</td>
<td>8</td>
</tr>
<tr>
<td>2017-01-17 22:00:00</td>
<td>6</td>
</tr>
<tr>
<td>2017-01-17 21:30:00</td>
<td>14</td>
</tr>
<tr>
<td>2017-01-17 21:00:00</td>
<td>18</td>
</tr>
<tr>
<td>2017-01-17 20:30:00</td>
<td>24</td>
</tr>
<tr>
<td>2017-01-17 20:00:00</td>
<td>28</td>
</tr>
<tr>
<td>2017-01-17 19:30:00</td>
<td>37</td>
</tr>
<tr>
<td>2017-01-17 19:00:00</td>
<td>25</td>
</tr>
<tr>
<td>2017-01-17 18:30:00</td>
<td>21</td>
</tr>
<tr>
<td>2017-01-17 18:00:00</td>
<td>37</td>
</tr>
<tr>
<td>2017-01-17 17:30:00</td>
<td>36</td>
</tr>
<tr>
<td>2017-01-17 17:00:00</td>
<td>48</td>
</tr>
<tr>
<td>2017-01-17 16:30:00</td>
<td>31</td>
</tr>
<tr>
<td>2017-01-17 16:00:00</td>
<td>46</td>
</tr>
<tr>
<td>2017-01-17 15:30:00</td>
<td>36</td>
</tr>
<tr>
<td>2017-01-17 15:00:00</td>
<td>37</td>
</tr>
<tr>
<td>2017-01-17 14:30:00</td>
<td>33</td>
</tr>
<tr>
<td>2017-01-17 14:00:00</td>
<td>31</td>
</tr>
<tr>
<td>2017-01-17 13:30:00</td>
<td>41</td>
</tr>
<tr>
<td>2017-01-17 13:00:00</td>
<td>37</td>
</tr>
<tr>
<td>2017-01-17 12:30:00</td>
<td>22</td>
</tr>
<tr>
<td>2017-01-17 12:00:00</td>
<td>30</td>
</tr>
<tr>
<td>2017-01-17 11:30:00</td>
<td>33</td>
</tr>
<tr>
<td>2017-01-17 11:00:00</td>
<td>27</td>
</tr>
<tr>
<td>2017-01-17 10:30:00</td>
<td>21</td>
</tr>
<tr>
<td>2017-01-17 10:00:00</td>
<td>23</td>
</tr>
<tr>
<td>2017-01-17 09:30:00</td>
<td>8</td>
</tr>
<tr>
<td>2017-01-17 09:00:00</td>
<td>9</td>
</tr>
<tr>
<td>2017-01-17 08:30:00</td>
<td>2</td>
</tr>
<tr>
<td>2017-01-17 08:00:00</td>
<td>1</td>
</tr>
<tr>
<td>2017-01-17 07:00:00</td>
<td>1</td>
</tr>
<tr>
<td>2017-01-17 00:30:00</td>
<td>1</td>
</tr>
<tr>
<td>2017-01-17 00:00:00</td>
<td>1</td>
</tr>
</tbody>
</table>

      

      
    </div>
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags"></i>
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Mysql/">Mysql</a></li></ul>
	</div>

      

      
        <p class="article-more-link">
          <a class="article-more-a" href="/2017/01/18/Mysql任意时间范围内按任意时段分组/">展开全文 >></a>
        </p>
      

      
      <div class="clearfix"></div>
    </div>
  </div>
</article>








  
    <article id="post-vuex的理解" class="article article-type-post  article-index" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/12/27/vuex的理解/">vuex的理解</a>
    </h1>
  

        <a href="/2016/12/27/vuex的理解/" class="archive-article-date">
  	<time datetime="2016-12-27T12:42:06.000Z" itemprop="datePublished"><i class="icon-calendar icon"></i>2016-12-27</time>
</a>
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>vue2的状态管理模式vuex类似react的redux，都是提供一个单一状态树的模型store。</p>
<p>数据操作部分：redux是分别编写action和reducer，然后将state和action映射为组件的props，reducer部分则与组件没有直接关系，只负责修改state；vuex的store中可以定义一些数据操作的方法，getters是读取过滤数据的公共操作，mutations是修改数据的公共操作，actions是异步修改数据的公共操作，然后定义组件时可以映射这些公共操作。</p>
<p>数据模块化：redux可以按store的数据结构自行拆分模块，然后分模块组织action和reducer；vuex则提供了modules，每个module可以拥有自己的state、mutations、actions、getters，甚至是子module——从上到下的分割。</p>
<p>整体来看，vuex和redux提供的功能是类似的，redux把action和reducer分开的做法逻辑上和代码上都更为分散，写起来相对繁琐，而vuex把state和相关操作整合在一起，用户的关注点聚集在数据上，写起来简洁，看起来直观，理解上也较容易。</p>

      

      
    </div>
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags"></i>
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/vue/">vue</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/vuex/">vuex</a></li></ul>
	</div>

      

      
        <p class="article-more-link">
          <a class="article-more-a" href="/2016/12/27/vuex的理解/">展开全文 >></a>
        </p>
      

      
      <div class="clearfix"></div>
    </div>
  </div>
</article>








  
    <article id="post-缘起缘灭" class="article article-type-post  article-index" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/12/22/缘起缘灭/">缘起缘灭</a>
    </h1>
  

        <a href="/2016/12/22/缘起缘灭/" class="archive-article-date">
  	<time datetime="2016-12-22T13:06:37.000Z" itemprop="datePublished"><i class="icon-calendar icon"></i>2016-12-22</time>
</a>
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>谷歌搜索Vert.x的EventBus相关的文章，被这篇<a href="http://www.sczyh30.com/posts/Vert-x/vertx-advanced-local-event-bus-internal/" target="_blank" rel="external">Vert.x 技术内幕 | Event Bus 源码分析 (Local模式)</a>吸引，文章不错，网站也不错，更厉害的是作者竟然只是一个大三学生，却熟悉各种前沿技术，很勤奋的写了大量源码解读博客，还有英文版，在github更有诸多项目实践，实在佩服，果断关注。</p>
<p>一时兴起，又决定仿照搭建自己的博客，原来是大名鼎鼎的Hexo框架，跑起来后又觉得原生主题不甚满意，又折腾切换主题，有幸找到<a href="http://litten.me/" target="_blank" rel="external">Litten</a>的<a href="https://github.com/litten/hexo-theme-yilia" target="_blank" rel="external">yilia</a>主题，细细一看，原来又是一个很厉害的人，腾讯的前端工程师，博客却写得完全不像是一个程序员，文字很赞，音乐也很赞，主题非常棒，谢谢。</p>
<p>谢谢这些厉害又热爱分享的人，学习，感恩。</p>

      

      
    </div>
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags"></i>
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/随笔/">随笔</a></li></ul>
	</div>

      

      
        <p class="article-more-link">
          <a class="article-more-a" href="/2016/12/22/缘起缘灭/">展开全文 >></a>
        </p>
      

      
      <div class="clearfix"></div>
    </div>
  </div>
</article>








  
    <article id="post-hello-world" class="article article-type-post  article-index" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/12/22/hello-world/">Hello World</a>
    </h1>
  

        <a href="/2016/12/22/hello-world/" class="archive-article-date">
  	<time datetime="2016-12-22T10:40:39.106Z" itemprop="datePublished"><i class="icon-calendar icon"></i>2016-12-22</time>
</a>
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>Welcome to <a href="https://hexo.io/" target="_blank" rel="external">Hexo</a>! This is your very first post. Check <a href="https://hexo.io/docs/" target="_blank" rel="external">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href="https://hexo.io/docs/troubleshooting.html" target="_blank" rel="external">troubleshooting</a> or you can ask me on <a href="https://github.com/hexojs/hexo/issues" target="_blank" rel="external">GitHub</a>.</p>
<h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ hexo new <span class="string">"My New Post"</span></div></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/writing.html" target="_blank" rel="external">Writing</a></p>
<h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ hexo server</div></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/server.html" target="_blank" rel="external">Server</a></p>
<h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ hexo generate</div></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/generating.html" target="_blank" rel="external">Generating</a></p>
<h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ hexo deploy</div></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/deployment.html" target="_blank" rel="external">Deployment</a></p>

      

      
    </div>
    <div class="article-info article-info-index">
      
      
      

      
        <p class="article-more-link">
          <a class="article-more-a" href="/2016/12/22/hello-world/">展开全文 >></a>
        </p>
      

      
      <div class="clearfix"></div>
    </div>
  </div>
</article>








  
  


          </div>
        </div>
      </div>
      <footer id="footer">
  <div class="outer">
    <div id="footer-info">
    	<div class="footer-left">
    		&copy; 2017 水西
    	</div>
      	<div class="footer-right">
      		<a href="http://hexo.io/" target="_blank">Hexo</a>  Theme <a href="https://github.com/litten/hexo-theme-yilia" target="_blank">Yilia</a> by Litten
      	</div>
    </div>
  </div>
</footer>
    </div>
    <script>
	var yiliaConfig = {
		mathjax: false,
		isHome: true,
		isPost: false,
		isArchive: false,
		isTag: false,
		isCategory: false,
		open_in_new: false,
		root: "/",
		innerArchive: true
	}
</script>

<script src="/./main.js?v=4.0.0.js"></script>


    
<div class="tools-col" q-class="show:isShow,hide:isShow|isFalse" q-on="click:stop(e)">
  <div class="tools-wrap">
    
    	<section class="tools-section tools-section-all" q-show="innerArchive">
        <div class="search-wrap">
          <input class="search-ipt" q-model="search" type="text" placeholder="find something…">
          <i class="icon-search icon" q-show="search|isEmptyStr"></i>
          <i class="icon-close icon" q-show="search|isNotEmptyStr" q-on="click:clearChose(e)"></i>
        </div>
        <div class="widget tagcloud search-tag">
          <p class="search-tag-wording">tag:</p>
          <label class="search-switch">
            <input type="checkbox" q-on="click:toggleTag(e)" q-attr="checked:showTags">
          </label>
          <ul class="article-tag-list" q-show="showTags">
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)">SPA</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)">webpack</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)">全栈</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)">drill</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)">sql</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)">mongodb</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)">Mysql</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)">随笔</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)">vuex</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)">vue</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)">Countly</a>
              </li>
            
            <div class="clearfix"></div>
          </ul>
        </div>
        <ul class="search-ul">
          <p q-show="jsonFail" style="padding: 20px; font-size: 12px;">
            缺失模块。<br/>1、在博客根目录（注意不是yilia根目录）执行以下命令：<br/> npm i hexo-generator-json-content --save<br/><br/>
            2、在根目录_config.yml里添加配置：
<pre style="font-size: 12px;" q-show="jsonFail">
  jsonContent:
    meta: false
    pages: false
    posts:
      title: true
      date: true
      path: true
      text: true
      raw: false
      content: false
      slug: false
      updated: false
      comments: false
      link: false
      permalink: false
      excerpt: false
      categories: false
      tags: true
</pre>
          </p>
          <li class="search-li" q-repeat="items" q-show="isShow">
            <a q-attr="href:path|urlformat" class="search-title"><i class="icon-quo-left icon"></i><span q-text="title"></span></a>
            <p class="search-time">
              <i class="icon-calendar icon"></i>
              <span q-text="date|dateformat"></span>
            </p>
            <p class="search-tag">
              <i class="icon-price-tags icon"></i>
              <span q-repeat="tags" q-on="click:choseTag(e, name)" q-text="name|tagformat"></span>
            </p>
          </li>
        </ul>
    	</section>
    

    

    
    	<section class="tools-section tools-section-me" q-show="aboutme">
  	  	
  	  		<div class="aboutme-wrap" id="js-aboutme">很惭愧&lt;br&gt;&lt;br&gt;只做了一点微小的工作&lt;br&gt;谢谢大家</div>
  	  	
    	</section>
    
  </div>
  
</div>
    <!-- Root element of PhotoSwipe. Must have class pswp. -->
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    <!-- Background of PhotoSwipe. 
         It's a separate element as animating opacity is faster than rgba(). -->
    <div class="pswp__bg"></div>

    <!-- Slides wrapper with overflow:hidden. -->
    <div class="pswp__scroll-wrap">

        <!-- Container that holds slides. 
            PhotoSwipe keeps only 3 of them in the DOM to save memory.
            Don't modify these 3 pswp__item elements, data is added later on. -->
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                <!--  Controls are self-explanatory. Order can be changed. -->

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" style="display:none" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                <!-- Preloader demo http://codepen.io/dimsemenov/pen/yyBWoR -->
                <!-- element will get class pswp__preloader--active when preloader is running -->
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                      <div class="pswp__preloader__cut">
                        <div class="pswp__preloader__donut"></div>
                      </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div> 
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div>
  </div>
</body>
</html>