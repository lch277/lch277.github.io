---
title: 好友圈和群聊设计  
date: 2018-12-04 20:42:06   
tags: 
- feed
---

[TOC]



## 需求

1. 好友圈（信息流）
   - 基于现有的通讯录好友
   - 发布动态（图片、语音转文字、表情）
   - 浏览好友圈（自己和所有好友的动态，含点赞信息）
   - 浏览我的动态（含点赞信息）
   - 点赞
   - 新动态、新点赞提醒（红点标注提示）
2. 运营号
   - 默认是所有用户的好友，但并不出现在好友列表
   - 发布动态推送给所有好友
   - 自动给所有人的动态点赞
3. 群聊
   - 创建群
   - 获取群列表
   - 获取群详情
   - 加群
   - 退群
   - 解散群

## 数据结构

### 好友圈

普通用户发布feed采用推模式，每个用户一个收件箱，每发布一条feed先存入自己的发件箱，再写入好友的收件箱，

- 信息流发件箱（feed）：mysql存储feed实体
  - id
  - uuid
  - content
  - content_type：文字、表情、图片、视频
  - feed_type：普通、运营、广告
  - likes
  - created_at: Timestamp
- 信息流收件箱（feed_inbox）：redis zset只存储feed id和时间戳
  - member：id
  - score：Timestamp
- 信息点赞表（feed_like)
  - id
  - feed
  - uuid
  - created_at: Timestamp
- 信息流读取进度（feed_offset）：存储在服务器的时间戳，用户最后读取信息流的位置，所有的动态或点赞只要大于此时间戳即认为是新的
- 信息流最新版本（feed_v）：存储在服务器的时间戳，任何新的动态或点赞均会更新此时间戳，此字段可以考虑从inbox中读取，inbox没有则使用当前时间戳

### 运营号

类似超级大V，默认系统所有人都是其好友

- 用户拉取时自动查询此类好友信息

- 不定期发布运营feed（活动、广告、心情等）

  此处采用推模式的工作量和数据量都非常大，考虑用户拉取feed流时合并其发件箱，此所谓拉模式

- 自动给所有用户的feed点赞

  同样工作量和数据量都非常大，考虑用户拉取feed流时再自动点赞，或者用户本地程序做缺省处理

- 另一种思路：对超级大V的好友区分活跃用户和非活跃用户，活跃用户使用推模式，非活跃用户使用拉模式

### 群聊

- 群组表（chat_group)
  - id
  - name
  - icon
  - owner
  - creator
  - created_at: Timestamp
- 群组成员表（chat_group_member)
  - id
  - uuid
  - group
  - created_at: Timestamp

## Tricks

一条语句提取feeds和likes

```sql
select d.*, group_concat(CONCAT_WS(',', c.D_ID, c.D_ENABLED) SEPARATOR '|') classes from w_feed d inner join w_feed_like c on d.D_UUID = c.D_UUID where d.D_UUID in ('D05BE7DC24014667', 'D05BFA005E007C6F') group by d.D_UUID
```



