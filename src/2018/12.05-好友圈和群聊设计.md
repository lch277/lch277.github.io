---
title: 好友圈和群聊设计  
date: 2018-12-04 20:42:06   
tags: 
- feed
---

[TOC]



## 需求

1. 好友圈（信息流，基于现有的通讯录好友）
   - 发布动态（图片、语音转文字、表情）
   - 浏览好友圈（自己和所有好友的动态，含点赞信息）
   - 浏览我的动态（含点赞信息）
   - 点赞
   - 新动态、新点赞提醒（红点标注提示）
2. 运营号
   - 发布动态推送给所有人
   - 自动给所有人的动态点赞
3. 群聊
   - 创建群
   - 获取群列表
   - 获取群详情
   - 加群
   - 退群
   - 踢人
   - 解散群

## 数据结构

### 好友圈

普通用户发布feed采用推模式，每个用户一个收件箱，每发布一条feed先存入自己的发件箱，再将id和时间戳写入好友的收件箱，如果要删除feed，则直接删除自己发件箱的feed实体

- 动态发件箱（feed）：mysql存储feed实体
  - id
  - uuid：发布者
  - m：动态内容
  - mtype：文字、心情、图片、视频
  - type：普通、运营、广告
  - like：点赞时会增加此数字
  - ts: 时间戳ms
- 动态收件箱（feed_inbox）：redis zset只存储feed id和时间戳
  - member：id
    - score：时间戳ms
- 点赞表（feed_like)
  - id
  - uuid：点赞的人
  - feed：动态id
  - to：被赞的人
  - ts: 时间戳ms
- 评论表（feed_comment）
  - id
  - uuid：评论作者
  - feed：动态id
  - m：评论内容，仅文字表情
  - to：被评论的人
  - ts：时间戳ms

多个流，微信可能的做法：

- 动态有一个独立的收件箱，每次收到新的动态（自己的除外）则通知客户端有更新（含头像），
- 客户端看到更新提示进入朋友圈获取最新的动态（含点赞和评论），然后依次获取历史动态
  - 本地储存刷新时间戳，比对赞的时间是否决定红点标识
- 点赞和评论的提醒消息共用另外一个收件箱，每次有新的点赞或评论则投递一条消息到收件箱，然后通知客户端有新消息
- 客户端依次获取提醒消息，服务器存储最后读取进度，读取状态应该属于本地管理

信息流和点赞分开读取，分开管理读取进度

信息流读取进度（feed_offset）：存储在服务器的时间戳，用户最后读取信息流的位置，所有的动态或点赞只要大于此时间戳即认为是新的

信息流最新版本（feed_v）：存储在服务器的时间戳，任何新的动态或点赞均会更新此时间戳，此字段可以考虑从inbox中读取，inbox没有则使用当前时间戳

### 运营号

类似超级大V，默认系统所有人都是其好友

- 用户拉取时自动查询此类好友信息

- 不定期发布运营feed（活动、广告、心情等）

  此处采用推模式的工作量和数据量都非常大，考虑用户拉取feed流时合并其发件箱，此所谓拉模式

- 自动给所有用户的feed点赞

  同样工作量和数据量都非常大，考虑用户拉取feed流时再自动点赞，或者用户本地程序做缺省处理

- 另一种思路：对超级大V的好友区分活跃用户和非活跃用户，活跃用户使用推模式，非活跃用户使用拉模式

### 群聊

- 群组表（chat_group)
  - id
  - name
  - icon
  - owner
  - creator
  - created_at: Timestamp
- 群组成员表（chat_group_member)
  - id
  - uuid
  - group
  - created_at: Timestamp

## Tricks

一条语句提取feeds和likes

```sql
select d.*, group_concat(CONCAT_WS(',', c.D_ID, c.D_ENABLED) SEPARATOR '|') classes from w_feed d inner join w_feed_like c on d.D_UUID = c.D_UUID where d.D_UUID in ('D05BE7DC24014667', 'D05BFA005E007C6F') group by d.D_UUID
```



